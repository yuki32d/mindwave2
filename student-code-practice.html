<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Practice — MindWave</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="student-theme.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="theme-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            background: var(--bg);
            color: var(--text);
        }

        /* ── TOPBAR ── */
        .cp-topbar {
            display: flex;
            align-items: center;
            gap: 12px;
            height: 52px;
            padding: 0 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 10;
        }

        .cp-back {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all .15s;
        }

        .cp-back:hover {
            color: var(--text);
            border-color: var(--border-2);
        }

        .cp-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
        }

        .cp-brand-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cp-brand-icon [data-lucide] {
            width: 14px;
            height: 14px;
            color: #fff;
        }

        .cp-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 7px;
            background: rgba(99, 102, 241, .15);
            color: var(--accent);
            border: 1px solid rgba(99, 102, 241, .3);
            border-radius: 20px;
            letter-spacing: .5px;
        }

        .cp-spacer {
            flex: 1;
        }

        .cp-challenge-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--muted);
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cp-diff-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 20px;
        }

        .diff-easy {
            background: rgba(34, 211, 165, .15);
            color: var(--green);
            border: 1px solid rgba(34, 211, 165, .25);
        }

        .diff-medium {
            background: rgba(245, 158, 11, .15);
            color: var(--orange);
            border: 1px solid rgba(245, 158, 11, .25);
        }

        .diff-hard {
            background: rgba(244, 63, 94, .15);
            color: var(--red);
            border: 1px solid rgba(244, 63, 94, .25);
        }

        .cp-lang-select {
            padding: 6px 10px;
            border-radius: 8px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            outline: none;
        }

        .cp-lang-select:focus {
            border-color: var(--accent);
        }

        .cp-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all .15s;
        }

        .cp-btn [data-lucide] {
            width: 14px;
            height: 14px;
        }

        .cp-btn-run {
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .cp-btn-run:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .cp-btn-submit {
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            color: #fff;
        }

        .cp-btn-submit:hover {
            opacity: .9;
            transform: translateY(-1px);
        }

        .cp-btn:disabled {
            opacity: .5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ── LAYOUT ── */
        .cp-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ── LEFT PANEL ── */
        .cp-left {
            width: 340px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            overflow: hidden;
        }

        .cp-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
        }

        .cp-tab {
            padding: 10px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            transition: all .15s;
        }

        .cp-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .cp-tab-panel {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .cp-tab-panel.active {
            display: flex;
            flex-direction: column;
        }

        /* Challenge list */
        .cp-challenge-list {
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .cp-challenge-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background .15s;
            border: 1px solid transparent;
        }

        .cp-challenge-item:hover {
            background: var(--surface-2);
        }

        .cp-challenge-item.active {
            background: rgba(99, 102, 241, .1);
            border-color: rgba(99, 102, 241, .25);
        }

        .cp-challenge-num {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            background: var(--surface-2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: var(--muted);
            flex-shrink: 0;
        }

        .cp-challenge-item.solved .cp-challenge-num {
            background: rgba(34, 211, 165, .15);
            color: var(--green);
        }

        .cp-challenge-item.failed .cp-challenge-num {
            background: rgba(244, 63, 94, .1);
            color: var(--red);
        }

        .cp-challenge-info {
            flex: 1;
            min-width: 0;
        }

        .cp-challenge-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            line-height: 1.3;
        }

        .cp-challenge-cat {
            font-size: 11px;
            color: var(--muted);
            margin-top: 2px;
        }

        .cp-challenge-diff {
            font-size: 10px;
            font-weight: 700;
            flex-shrink: 0;
        }

        /* Problem detail */
        .cp-problem {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .cp-problem-header {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .cp-problem-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }

        .cp-problem-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .cp-tag {
            font-size: 10px;
            padding: 2px 7px;
            border-radius: 20px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--muted);
        }

        .cp-section-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--muted);
            letter-spacing: .5px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .cp-desc {
            font-size: 13px;
            color: var(--text);
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .cp-example {
            background: var(--surface-2);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--border);
        }

        .cp-example-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .cp-example pre {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: var(--text);
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .cp-constraints {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cp-constraint {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            gap: 6px;
            align-items: flex-start;
        }

        .cp-constraint::before {
            content: '•';
            color: var(--accent);
            flex-shrink: 0;
            margin-top: 1px;
        }

        /* ── CENTER: EDITOR ── */
        .cp-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }

        .cp-editor-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .cp-editor-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cp-editor-label [data-lucide] {
            width: 13px;
            height: 13px;
        }

        #monacoContainer {
            flex: 1;
        }

        /* ── RIGHT: OUTPUT ── */
        .cp-right {
            width: 320px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
            overflow: hidden;
        }

        .cp-output-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
        }

        .cp-output-panel {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow-y: auto;
            padding: 12px;
            gap: 10px;
        }

        .cp-output-panel.active {
            display: flex;
        }

        /* Test results */
        .cp-run-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-idle {
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--muted);
        }

        .status-running {
            background: rgba(245, 158, 11, .1);
            border: 1px solid rgba(245, 158, 11, .25);
            color: var(--orange);
        }

        .status-pass {
            background: rgba(34, 211, 165, .1);
            border: 1px solid rgba(34, 211, 165, .25);
            color: var(--green);
        }

        .status-fail {
            background: rgba(244, 63, 94, .1);
            border: 1px solid rgba(244, 63, 94, .25);
            color: var(--red);
        }

        .cp-run-status [data-lucide] {
            width: 15px;
            height: 15px;
        }

        .cp-test-case {
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--surface-2);
            overflow: hidden;
        }

        .cp-test-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
        }

        .cp-test-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .cp-test-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .test-pending {
            background: var(--surface);
            border: 1px solid var(--border);
        }

        .test-pass {
            background: rgba(34, 211, 165, .2);
        }

        .test-fail {
            background: rgba(244, 63, 94, .2);
        }

        .cp-test-icon [data-lucide] {
            width: 10px;
            height: 10px;
        }

        .cp-test-body {
            padding: 10px 12px;
            border-top: 1px solid var(--border);
            display: none;
        }

        .cp-test-body.open {
            display: block;
        }

        .cp-test-row {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-bottom: 8px;
        }

        .cp-test-row:last-child {
            margin-bottom: 0;
        }

        .cp-test-key {
            font-size: 10px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .5px;
        }

        .cp-test-val {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 8px;
            color: var(--text);
            white-space: pre-wrap;
            word-break: break-all;
        }

        .cp-test-val.wrong {
            border-color: rgba(244, 63, 94, .4);
            background: rgba(244, 63, 94, .05);
        }

        /* Console output */
        .cp-console-box {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: var(--text);
            white-space: pre-wrap;
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .cp-console-box .err {
            color: var(--red);
        }

        .cp-console-box .ok {
            color: var(--green);
        }

        .cp-console-empty {
            color: var(--muted);
            font-style: italic;
        }

        /* Stats */
        .cp-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .cp-stat-card {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .cp-stat-val {
            font-size: 20px;
            font-weight: 800;
            color: var(--accent);
        }

        .cp-stat-label {
            font-size: 11px;
            color: var(--muted);
            margin-top: 2px;
        }

        /* Pyodide loader */
        .cp-loader {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 9999;
        }

        .cp-loader-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .cp-loader-text {
            font-size: 14px;
            color: var(--muted);
        }

        /* ── XP BADGE ── */
        .cp-xp {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 8px;
            background: rgba(99, 102, 241, .12);
            border: 1px solid rgba(99, 102, 241, .25);
            font-size: 12px;
            font-weight: 700;
            color: var(--accent);
        }

        .cp-xp [data-lucide] {
            width: 12px;
            height: 12px;
        }

        .cp-xp-pop {
            animation: xpPop .4s cubic-bezier(.34, 1.56, .64, 1);
        }

        @keyframes xpPop {
            0% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.3)
            }

            100% {
                transform: scale(1)
            }
        }

        /* ── HINTS ── */
        .cp-hints {
            border-top: 1px solid var(--border);
            padding: 14px 16px;
        }

        .cp-hint-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            color: var(--muted);
            letter-spacing: .5px;
            text-transform: uppercase;
        }

        .cp-hint-header [data-lucide] {
            width: 13px;
            height: 13px;
        }

        .cp-hint-list {
            display: none;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cp-hint-item {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .cp-hint-trigger {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
        }

        .cp-hint-trigger [data-lucide] {
            width: 12px;
            height: 12px;
            color: var(--muted);
        }

        .cp-hint-body {
            display: none;
            padding: 8px 12px;
            font-size: 12px;
            color: var(--muted);
            line-height: 1.6;
            border-top: 1px solid var(--border);
        }

        .cp-hint-body.open {
            display: block;
        }

        /* ── REFERENCE PANEL ── */
        .cp-ref {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .cp-ref-lang {
            display: flex;
            gap: 6px;
            margin-bottom: 4px;
        }

        .cp-ref-lang-btn {
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: none;
            color: var(--muted);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        .cp-ref-lang-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .cp-ref-section {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .cp-ref-section-header {
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .5px;
            border-bottom: 1px solid var(--border);
        }

        .cp-ref-item {
            display: flex;
            gap: 8px;
            padding: 7px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            align-items: flex-start;
        }

        .cp-ref-item:last-child {
            border-bottom: none;
        }

        .cp-ref-code {
            font-family: 'Consolas', 'Monaco', monospace;
            background: var(--surface);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--accent);
            font-size: 11px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .cp-ref-desc {
            color: var(--muted);
            line-height: 1.5;
        }

        /* ── AI PANEL ── */
        .cp-ai-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .cp-ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .cp-ai-msg {
            max-width: 90%;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 12px;
            line-height: 1.6;
        }

        .cp-ai-msg.assistant {
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text);
            align-self: flex-start;
        }

        .cp-ai-msg.user {
            background: rgba(99, 102, 241, .15);
            border: 1px solid rgba(99, 102, 241, .25);
            color: var(--text);
            align-self: flex-end;
        }

        .cp-ai-input-row {
            display: flex;
            gap: 6px;
            padding: 10px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .cp-ai-input {
            flex: 1;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 7px 10px;
            color: var(--text);
            font-size: 12px;
            outline: none;
            resize: none;
            font-family: inherit;
        }

        .cp-ai-input:focus {
            border-color: var(--accent);
        }

        .cp-ai-send {
            padding: 7px 12px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .cp-ai-send [data-lucide] {
            width: 13px;
            height: 13px;
        }

        .cp-ai-quick {
            display: flex;
            gap: 5px;
            padding: 0 10px 8px;
            flex-wrap: wrap;
        }

        .cp-ai-quick-btn {
            padding: 4px 8px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: none;
            color: var(--muted);
            font-size: 11px;
            cursor: pointer;
        }

        .cp-ai-quick-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .cp-ai-typing {
            display: flex;
            gap: 3px;
            padding: 4px 2px;
            align-items: center;
        }

        .cp-ai-typing span {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--muted);
            animation: aiDot 1.2s ease-in-out infinite;
        }

        .cp-ai-typing span:nth-child(2) {
            animation-delay: .2s
        }

        .cp-ai-typing span:nth-child(3) {
            animation-delay: .4s
        }

        @keyframes aiDot {

            0%,
            100% {
                opacity: .3;
                transform: translateY(0)
            }

            50% {
                opacity: 1;
                transform: translateY(-3px)
            }
        }

        /* ── VISUALIZER MODAL ── */
        .cp-viz-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            backdrop-filter: blur(4px);
            z-index: 9998;
            align-items: center;
            justify-content: center;
        }

        .cp-viz-overlay.open {
            display: flex;
        }

        .cp-viz-modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 700px;
            max-width: 95vw;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 24px 60px rgba(0, 0, 0, .5);
        }

        .cp-viz-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
        }

        .cp-viz-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cp-viz-title [data-lucide] {
            width: 15px;
            height: 15px;
            color: var(--accent);
        }

        .cp-viz-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--muted);
            padding: 4px;
            border-radius: 6px;
        }

        .cp-viz-close:hover {
            color: var(--text);
            background: var(--surface-2);
        }

        .cp-viz-close [data-lucide] {
            width: 16px;
            height: 16px;
        }

        .cp-viz-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .cp-viz-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 0 0 4px;
        }

        .cp-viz-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .cp-viz-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .cp-viz-btn [data-lucide] {
            width: 12px;
            height: 12px;
        }

        .cp-viz-step-info {
            font-size: 12px;
            color: var(--muted);
            margin-left: auto;
        }

        .cp-viz-code {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.8;
            overflow-x: auto;
        }

        .cp-viz-line {
            padding: 1px 8px;
            border-radius: 4px;
            color: #d4d4d4;
        }

        .cp-viz-line.current {
            background: rgba(99, 102, 241, .25);
            color: #fff;
        }

        .cp-viz-vars {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .cp-viz-vars-header {
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .5px;
            border-bottom: 1px solid var(--border);
        }

        .cp-viz-var-row {
            display: flex;
            justify-content: space-between;
            padding: 7px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .cp-viz-var-row:last-child {
            border-bottom: none;
        }

        .cp-viz-var-name {
            color: var(--cyan);
            font-family: monospace;
        }

        .cp-viz-var-val {
            color: var(--orange);
            font-family: monospace;
        }
    </style>
</head>

<body>

    <!-- Loading overlay -->
    <div class="cp-loader" id="cpLoader">
        <div class="cp-loader-spinner"></div>
        <div class="cp-loader-text" id="loaderText">Initializing editor…</div>
    </div>

    <!-- TOPBAR -->
    <header class="cp-topbar">
        <a href="javascript:history.back()" class="cp-back">
            <i data-lucide="arrow-left"></i> Back
        </a>
        <div class="cp-brand">
            <div class="cp-brand-icon"><i data-lucide="brain-circuit"></i></div>
            <span>MindWave</span>
            <span class="cp-badge">CODE PRACTICE</span>
        </div>
        <div class="cp-spacer"></div>
        <span class="cp-challenge-title" id="topbarTitle">Select a challenge</span>
        <span class="cp-diff-badge" id="topbarDiff"></span>
        <div class="cp-spacer"></div>
        <div class="cp-xp" id="xpBadge"><i data-lucide="zap"></i> <span id="xpVal">0</span> XP</div>
        <select class="cp-lang-select" id="langSelect" onchange="onLangChange()">
            <option value="python">Python 3</option>
            <option value="javascript">JavaScript</option>
            <option value="java" disabled>Java (soon)</option>
            <option value="cpp" disabled>C++ (soon)</option>
        </select>
        <button class="cp-btn cp-btn-run" id="runBtn" onclick="runCode(false)">
            <i data-lucide="play"></i> Run
        </button>
        <button class="cp-btn cp-btn-submit" id="submitBtn" onclick="runCode(true)">
            <i data-lucide="check-circle-2"></i> Submit
        </button>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="cp-layout">

        <!-- LEFT: Problem panel -->
        <div class="cp-left">
            <div class="cp-tabs">
                <button class="cp-tab active" onclick="switchLeftTab('list',this)">
                    <i data-lucide="list"></i> Challenges
                </button>
                <button class="cp-tab" onclick="switchLeftTab('problem',this)">
                    <i data-lucide="file-text"></i> Problem
                </button>
                <button class="cp-tab" onclick="switchLeftTab('ref',this)">
                    <i data-lucide="book-open"></i> Ref
                </button>
            </div>
            <!-- Challenge list tab -->
            <div class="cp-tab-panel active" id="tab-list">
                <div class="cp-challenge-list" id="challengeList"></div>
            </div>
            <!-- Problem detail tab -->
            <div class="cp-tab-panel" id="tab-problem">
                <div class="cp-problem" id="problemDetail">
                    <p style="color:var(--muted);font-size:13px;">Select a challenge from the list.</p>
                </div>
            </div>
            <!-- Reference tab -->
            <div class="cp-tab-panel" id="tab-ref">
                <div class="cp-ref">
                    <div class="cp-ref-lang">
                        <button class="cp-ref-lang-btn active" onclick="switchRef('python',this)">Python</button>
                        <button class="cp-ref-lang-btn" onclick="switchRef('javascript',this)">JavaScript</button>
                    </div>
                    <div id="refContent"></div>
                </div>
            </div>
        </div>

        <!-- CENTER: Monaco Editor -->
        <div class="cp-center">
            <div class="cp-editor-topbar">
                <span class="cp-editor-label">
                    <i data-lucide="code-2"></i> Solution
                </span>
                <div style="display:flex;gap:6px;">
                    <button class="cp-btn" style="padding:4px 10px;font-size:12px;" onclick="openVisualizer()">
                        <i data-lucide="eye"></i> Visualize
                    </button>
                    <button class="cp-btn" style="padding:4px 10px;font-size:12px;" onclick="resetCode()">
                        <i data-lucide="rotate-ccw"></i> Reset
                    </button>
                </div>
            </div>
            <div id="monacoContainer"></div>
        </div>

        <!-- RIGHT: Output -->
        <div class="cp-right">
            <div class="cp-output-tabs">
                <button class="cp-tab active" onclick="switchRightTab('tests',this)">
                    <i data-lucide="check-square"></i> Tests
                </button>
                <button class="cp-tab" onclick="switchRightTab('console',this)">
                    <i data-lucide="terminal"></i> Console
                </button>
                <button class="cp-tab" onclick="switchRightTab('stats',this)">
                    <i data-lucide="bar-chart-2"></i> Stats
                </button>
                <button class="cp-tab" onclick="switchRightTab('ai',this)">
                    <i data-lucide="bot"></i> AI
                </button>
            </div>
            <div class="cp-output-panel active" id="tab-tests">
                <div class="cp-run-status status-idle" id="runStatus">
                    <i data-lucide="clock"></i> Run your code to see results
                </div>
                <div id="testCaseList"></div>
            </div>
            <div class="cp-output-panel" id="tab-console">
                <div class="cp-section-label">Output</div>
                <div class="cp-console-box" id="consoleBox">
                    <span class="cp-console-empty">Run your code to see output…</span>
                </div>
            </div>
            <div class="cp-output-panel" id="tab-stats">
                <div class="cp-section-label">Your Progress</div>
                <div class="cp-stats-grid">
                    <div class="cp-stat-card">
                        <div class="cp-stat-val" id="statSolved">0</div>
                        <div class="cp-stat-label">Solved</div>
                    </div>
                    <div class="cp-stat-card">
                        <div class="cp-stat-val" id="statAttempted">0</div>
                        <div class="cp-stat-label">Attempted</div>
                    </div>
                    <div class="cp-stat-card">
                        <div class="cp-stat-val" id="statAccuracy">0%</div>
                        <div class="cp-stat-label">Accuracy</div>
                    </div>
                    <div class="cp-stat-card">
                        <div class="cp-stat-val" id="statStreak">0</div>
                        <div class="cp-stat-label">Streak</div>
                    </div>
                </div>
            </div>
            <!-- AI Assistant tab -->
            <div class="cp-output-panel" id="tab-ai">
                <div class="cp-ai-panel">
                    <div class="cp-ai-messages" id="aiMessages">
                        <div class="cp-ai-msg assistant">Hi! I'm your AI coding assistant. Ask me to explain your error,
                            give a hint, or walk through the algorithm.</div>
                    </div>
                    <div class="cp-ai-quick">
                        <button class="cp-ai-quick-btn" onclick="aiQuick('Explain my error')">Explain error</button>
                        <button class="cp-ai-quick-btn" onclick="aiQuick('Give me a hint')">Hint</button>
                        <button class="cp-ai-quick-btn" onclick="aiQuick('Explain the algorithm')">Algorithm</button>
                        <button class="cp-ai-quick-btn" onclick="aiQuick('Review my code')">Review code</button>
                    </div>
                    <div class="cp-ai-input-row">
                        <textarea class="cp-ai-input" id="aiInput" rows="2"
                            placeholder="Ask anything about this challenge…"
                            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAiMessage();}"></textarea>
                        <button class="cp-ai-send" onclick="sendAiMessage()"><i data-lucide="send"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISUALIZER MODAL -->
    <div class="cp-viz-overlay" id="vizOverlay" onclick="if(event.target===this)closeVisualizer()">
        <div class="cp-viz-modal">
            <div class="cp-viz-header">
                <div class="cp-viz-title"><i data-lucide="eye"></i> Logic Visualizer</div>
                <button class="cp-viz-close" onclick="closeVisualizer()"><i data-lucide="x"></i></button>
            </div>
            <div class="cp-viz-body">
                <div class="cp-viz-controls">
                    <button class="cp-viz-btn" onclick="vizStep(-1)"><i data-lucide="skip-back"></i> Prev</button>
                    <button class="cp-viz-btn" onclick="vizStep(1)"><i data-lucide="skip-forward"></i> Next</button>
                    <button class="cp-viz-btn" onclick="vizRun()"><i data-lucide="play"></i> Auto</button>
                    <span class="cp-viz-step-info" id="vizStepInfo">Step 0 / 0</span>
                </div>
                <div class="cp-viz-code" id="vizCode"></div>
                <div class="cp-viz-vars">
                    <div class="cp-viz-vars-header">Variables</div>
                    <div id="vizVars">
                        <div class="cp-viz-var-row" style="color:var(--muted);font-size:12px;padding:12px">Run to see
                            variable state</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ── CHALLENGES DATA ──
        const CHALLENGES = [
            {
                id: 1, title: 'Hello World', difficulty: 'easy', category: 'Basics', tags: ['print', 'output'],
                description: 'Print "Hello, World!" to the output.',
                examples: [{ input: '(none)', output: 'Hello, World!' }],
                constraints: ['Use a print/console.log statement'],
                testCases: [{ input: '', expected: 'Hello, World!' }],
                starterCode: {
                    python: '# Write your solution\nprint("Hello, World!")',
                    javascript: '// Write your solution\nconsole.log("Hello, World!");'
                }
            },
            {
                id: 2, title: 'Sum of Two Numbers', difficulty: 'easy', category: 'Math', tags: ['addition', 'input'],
                description: 'Given two integers a and b on separate lines, print their sum.',
                examples: [{ input: '3\n5', output: '8' }, { input: '-1\n4', output: '3' }],
                constraints: ['−10^6 ≤ a, b ≤ 10^6'],
                testCases: [
                    { input: '3\n5', expected: '8' },
                    { input: '-1\n4', expected: '3' },
                    { input: '1000000\n-999999', expected: '1' }
                ],
                starterCode: {
                    python: 'a = int(input())\nb = int(input())\nprint(a + b)',
                    javascript: 'const [a,b] = input.trim().split("\\n").map(Number);\nconsole.log(a+b);'
                }
            },
            {
                id: 3, title: 'Palindrome Check', difficulty: 'easy', category: 'Strings', tags: ['string', 'palindrome'],
                description: 'Given a string s, print "YES" if it is a palindrome, "NO" otherwise. Ignore case.',
                examples: [{ input: 'racecar', output: 'YES' }, { input: 'hello', output: 'NO' }],
                constraints: ['1 ≤ len(s) ≤ 1000', 'Only alphabetic characters'],
                testCases: [
                    { input: 'racecar', expected: 'YES' },
                    { input: 'hello', expected: 'NO' },
                    { input: 'Madam', expected: 'YES' },
                    { input: 'Level', expected: 'YES' },
                    { input: 'world', expected: 'NO' }
                ],
                starterCode: {
                    python: 's = input().lower()\nprint("YES" if s == s[::-1] else "NO")',
                    javascript: 'const s = input.trim().toLowerCase();\nconsole.log(s === s.split("").reverse().join("") ? "YES" : "NO");'
                }
            },
            {
                id: 4, title: 'FizzBuzz', difficulty: 'easy', category: 'Logic', tags: ['modulo', 'loop'],
                description: 'Print numbers 1 to n. For multiples of 3 print "Fizz", for multiples of 5 print "Buzz", for both print "FizzBuzz".',
                examples: [{ input: '5', output: '1\n2\nFizz\n4\nBuzz' }],
                constraints: ['1 ≤ n ≤ 100'],
                testCases: [
                    { input: '5', expected: '1\n2\nFizz\n4\nBuzz' },
                    { input: '15', expected: '1\n2\nFizz\n4\nBuzz\nFizz\n7\n8\nFizz\nBuzz\n11\nFizz\n13\n14\nFizzBuzz' },
                    { input: '1', expected: '1' }
                ],
                starterCode: {
                    python: 'n = int(input())\nfor i in range(1,n+1):\n    if i%15==0: print("FizzBuzz")\n    elif i%3==0: print("Fizz")\n    elif i%5==0: print("Buzz")\n    else: print(i)',
                    javascript: 'const n=parseInt(input.trim());\nfor(let i=1;i<=n;i++){\n  if(i%15===0)console.log("FizzBuzz");\n  else if(i%3===0)console.log("Fizz");\n  else if(i%5===0)console.log("Buzz");\n  else console.log(i);\n}'
                }
            },
            {
                id: 5, title: 'Fibonacci Sequence', difficulty: 'easy', category: 'Math', tags: ['fibonacci', 'recursion'],
                description: 'Print the first n Fibonacci numbers separated by spaces.',
                examples: [{ input: '6', output: '0 1 1 2 3 5' }],
                constraints: ['1 ≤ n ≤ 30'],
                testCases: [
                    { input: '6', expected: '0 1 1 2 3 5' },
                    { input: '1', expected: '0' },
                    { input: '10', expected: '0 1 1 2 3 5 8 13 21 34' }
                ],
                starterCode: {
                    python: 'n=int(input())\na,b=0,1\nres=[]\nfor _ in range(n):\n    res.append(str(a))\n    a,b=b,a+b\nprint(" ".join(res))',
                    javascript: 'const n=parseInt(input.trim());let a=0,b=1,res=[];\nfor(let i=0;i<n;i++){res.push(a);[a,b]=[b,a+b];}\nconsole.log(res.join(" "));'
                }
            },
            {
                id: 6, title: 'Binary Search', difficulty: 'medium', category: 'Arrays', tags: ['search', 'sorted'],
                description: 'Given a sorted array and a target value, return the index of the target or -1 if not found.\n\nInput: First line is n, second line has n space-separated integers (sorted), third line is target.',
                examples: [{ input: '5\n1 3 5 7 9\n7', output: '3' }],
                constraints: ['1 ≤ n ≤ 10^5', 'Array is sorted in ascending order'],
                testCases: [
                    { input: '5\n1 3 5 7 9\n7', expected: '3' },
                    { input: '5\n1 3 5 7 9\n6', expected: '-1' },
                    { input: '1\n42\n42', expected: '0' }
                ],
                starterCode: {
                    python: 'data=input().split()\nn=int(data[0])\nnums=list(map(int,input().split()))\ntarget=int(input())\nlo,hi=0,n-1\nans=-1\nwhile lo<=hi:\n    mid=(lo+hi)//2\n    if nums[mid]==target:\n        ans=mid; break\n    elif nums[mid]<target: lo=mid+1\n    else: hi=mid-1\nprint(ans)',
                    javascript: 'const lines=input.trim().split("\\n");\nconst nums=lines[1].split(" ").map(Number);\nconst target=parseInt(lines[2]);\nlet lo=0,hi=nums.length-1,ans=-1;\nwhile(lo<=hi){const mid=(lo+hi)>>1;\nif(nums[mid]===target){ans=mid;break;}\nelse if(nums[mid]<target)lo=mid+1;\nelse hi=mid-1;}\nconsole.log(ans);'
                }
            },
            {
                id: 7, title: 'Valid Parentheses', difficulty: 'medium', category: 'Stack', tags: ['stack', 'string'],
                description: 'Given a string containing only "(", ")", "{", "}", "[", "]", determine if the brackets are valid.\n\nPrint "YES" if valid, "NO" otherwise.',
                examples: [{ input: '()[]{}', output: 'YES' }, { input: '(]', output: 'NO' }],
                constraints: ['1 ≤ len(s) ≤ 10^4'],
                testCases: [
                    { input: '()[]{}', expected: 'YES' },
                    { input: '(]', expected: 'NO' },
                    { input: '{[()]}', expected: 'YES' },
                    { input: '([)]', expected: 'NO' },
                    { input: '', expected: 'YES' }
                ],
                starterCode: {
                    python: 's=input()\nstack=[]\npairs={")":"(","]":"[","}":"{"}\nfor c in s:\n    if c in "([{": stack.append(c)\n    elif not stack or stack[-1]!=pairs[c]: print("NO"); exit()\n    else: stack.pop()\nprint("YES" if not stack else "NO")',
                    javascript: 'const s=input.trim();\nconst stack=[];\nconst pairs={")":"(","]":"[","}":"{"};\nfor(const c of s){\n  if("([{".includes(c))stack.push(c);\n  else if(!stack.length||stack[stack.length-1]!==pairs[c]){console.log("NO");process.exit?.(0)||eval("throw 0");}\n  else stack.pop();\n}\nconsole.log(stack.length?"NO":"YES");'
                }
            },
            {
                id: 8, title: 'Maximum Subarray', difficulty: 'medium', category: 'Dynamic Programming', tags: ['dp', 'kadane'],
                description: "Find the contiguous subarray with the largest sum and print it.\n\nInput: First line is n, second line has n space-separated integers.",
                examples: [{ input: '6\n-2 1 -3 4 -1 2 1 -5 4', output: '6' }],
                constraints: ['1 ≤ n ≤ 10^5', '−10^4 ≤ nums[i] ≤ 10^4'],
                testCases: [
                    { input: '9\n-2 1 -3 4 -1 2 1 -5 4', expected: '6' },
                    { input: '1\n-1', expected: '-1' },
                    { input: '4\n1 2 3 4', expected: '10' }
                ],
                starterCode: {
                    python: 'n=int(input())\nnums=list(map(int,input().split()))\ncur=best=nums[0]\nfor x in nums[1:]:\n    cur=max(x,cur+x)\n    best=max(best,cur)\nprint(best)',
                    javascript: 'const lines=input.trim().split("\\n");\nconst nums=lines[1].split(" ").map(Number);\nlet cur=nums[0],best=nums[0];\nfor(let i=1;i<nums.length;i++){cur=Math.max(nums[i],cur+nums[i]);best=Math.max(best,cur);}\nconsole.log(best);'
                }
            },
            {
                id: 9, title: 'Two Sum', difficulty: 'medium', category: 'Arrays', tags: ['hash table', 'array'],
                description: 'Given an array of integers and a target, print the indices (0-based) of the two numbers that add up to target, space-separated.\n\nInput: First line is n, second line has nums, third line is target.',
                examples: [{ input: '4\n2 7 11 15\n9', output: '0 1' }],
                constraints: ['2 ≤ n ≤ 10^4', 'Exactly one solution exists'],
                testCases: [
                    { input: '4\n2 7 11 15\n9', expected: '0 1' },
                    { input: '3\n3 2 4\n6', expected: '1 2' },
                    { input: '2\n3 3\n6', expected: '0 1' }
                ],
                starterCode: {
                    python: 'lines=__import__("sys").stdin.read().split("\\n")\nn=int(lines[0])\nnums=list(map(int,lines[1].split()))\ntarget=int(lines[2])\nseen={}\nfor i,v in enumerate(nums):\n    if target-v in seen:\n        print(seen[target-v],i); break\n    seen[v]=i',
                    javascript: 'const lines=input.trim().split("\\n");\nconst nums=lines[1].split(" ").map(Number);\nconst target=parseInt(lines[2]);\nconst seen={};\nfor(let i=0;i<nums.length;i++){\n  const c=target-nums[i];\n  if(c in seen){console.log(seen[c]+" "+i);break;}\n  seen[nums[i]]=i;\n}'
                }
            },
            {
                id: 10, title: 'Word Frequency', difficulty: 'hard', category: 'Strings', tags: ['hash map', 'counting'],
                description: 'Given a sentence, print each unique word with its frequency sorted by frequency (descending). Ties broken alphabetically.\n\nOutput format: "word count" per line.',
                examples: [{ input: 'apple banana apple cherry banana apple', output: 'apple 3\nbanana 2\ncherry 1' }],
                constraints: ['Words are lowercase', '1 ≤ words ≤ 10^4'],
                testCases: [
                    { input: 'apple banana apple cherry banana apple', expected: 'apple 3\nbanana 2\ncherry 1' },
                    { input: 'hello world hello', expected: 'hello 2\nworld 1' },
                    { input: 'a b c a b a', expected: 'a 3\nb 2\nc 1' }
                ],
                starterCode: {
                    python: 'from collections import Counter\nwords=input().split()\nc=Counter(words)\nfor w,n in sorted(c.items(),key=lambda x:(-x[1],x[0])):\n    print(f"{w} {n}")',
                    javascript: 'const words=input.trim().split(/\\s+/);\nconst c={};\nfor(const w of words)c[w]=(c[w]||0)+1;\nObject.entries(c).sort((a,b)=>b[1]-a[1]||a[0].localeCompare(b[0]))\n.forEach(([w,n])=>console.log(w+" "+n));'
                }
            }
        ];

        // ── STATE ──
        let editor = null;
        let pyodide = null;
        let currentChallenge = null;
        let userCode = {};
        let solved = JSON.parse(localStorage.getItem('cp_solved') || '{}');
        let stats = JSON.parse(localStorage.getItem('cp_stats') || '{"solved":0,"attempted":0,"runs":0,"correct":0}');

        // ── INIT ──
        async function init() {
            renderChallengeList();
            updateStats();
            initMonaco();
        }

        // ── CHALLENGE LIST ──
        function renderChallengeList() {
            const el = document.getElementById('challengeList');
            el.innerHTML = CHALLENGES.map(c => {
                const state = solved[c.id] ? 'solved' : '';
                return `<div class="cp-challenge-item ${state}" onclick="selectChallenge(${c.id})">
      <div class="cp-challenge-num">${state === 'solved' ? '<i data-lucide="check" style="width:10px;height:10px;color:var(--green)"></i>' : c.id}</div>
      <div class="cp-challenge-info">
        <div class="cp-challenge-name">${c.title}</div>
        <div class="cp-challenge-cat">${c.category}</div>
      </div>
      <span class="cp-diff-badge diff-${c.difficulty}">${c.difficulty}</span>
    </div>`;
            }).join('');
            lucide.createIcons();
        }

        function selectChallenge(id) {
            currentChallenge = CHALLENGES.find(c => c.id === id);
            if (!currentChallenge) return;

            // Highlight active
            document.querySelectorAll('.cp-challenge-item').forEach((el, i) => {
                el.classList.toggle('active', CHALLENGES[i].id === id);
            });

            // Topbar
            document.getElementById('topbarTitle').textContent = currentChallenge.title;
            const db = document.getElementById('topbarDiff');
            db.className = `cp-diff-badge diff-${currentChallenge.difficulty}`;
            db.textContent = currentChallenge.difficulty;

            // Render problem
            renderProblem();
            switchLeftTab('problem', document.querySelectorAll('.cp-tab')[1]);

            // Set editor code
            const lang = document.getElementById('langSelect').value;
            if (!userCode[id]) userCode[id] = {};
            if (!userCode[id][lang]) userCode[id][lang] = currentChallenge.starterCode[lang];
            if (editor) editor.setValue(userCode[id][lang]);
            setMonacoLang(lang);

            // Clear results
            resetOutput();
        }

        function renderProblem() {
            const c = currentChallenge;
            document.getElementById('problemDetail').innerHTML = `
    <div class="cp-problem-header">
      <div class="cp-problem-title">${c.title}</div>
      <div class="cp-problem-meta">
        <span class="cp-diff-badge diff-${c.difficulty}">${c.difficulty.toUpperCase()}</span>
        ${c.tags.map(t => `<span class="cp-tag">${t}</span>`).join('')}
      </div>
    </div>
    <div>
      <div class="cp-section-label">Description</div>
      <div class="cp-desc">${c.description}</div>
    </div>
    <div>
      <div class="cp-section-label">Examples</div>
      ${c.examples.map((ex, i) => `
        <div class="cp-example">
          <div class="cp-example-label">Example ${i + 1}</div>
          <pre><b>Input:</b>  ${ex.input || '(none)'}\n<b>Output:</b> ${ex.output}</pre>
        </div>`).join('')}
    </div>
    <div class="cp-constraints">
      <div class="cp-section-label">Constraints</div>
      ${c.constraints.map(con => `<div class="cp-constraint">${con}</div>`).join('')}
    </div>`;
            // Append hints section inline
            const detail = document.getElementById('problemDetail');
            const hintsDiv = document.createElement('div');
            hintsDiv.className = 'cp-hints';
            hintsDiv.innerHTML = '<div class="cp-hint-header"><i data-lucide="lightbulb"></i> Hints</div><div id="hintsSection"></div>';
            detail.appendChild(hintsDiv);
            lucide.createIcons();
            // renderHints() is defined later; call deferred so HINTS is ready
            setTimeout(renderHints, 0);
        }

        // ── MONACO EDITOR ──
        function initMonaco() {
            require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                editor = monaco.editor.create(document.getElementById('monacoContainer'), {
                    value: '// Select a challenge to begin…',
                    language: 'python',
                    theme: document.documentElement.getAttribute('data-theme') === 'light' ? 'vs' : 'vs-dark',
                    fontSize: 14,
                    fontFamily: "'Cascadia Code','Fira Code','Consolas',monospace",
                    fontLigatures: true,
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false,
                    automaticLayout: true,
                    padding: { top: 16, bottom: 16 },
                    lineNumbers: 'on',
                    glyphMargin: false,
                    folding: false,
                    renderLineHighlight: 'line',
                    bracketPairColorization: { enabled: true },
                    wordWrap: 'on',
                    tabSize: 4,
                });
                editor.onDidChangeModelContent(() => {
                    if (currentChallenge) {
                        const lang = document.getElementById('langSelect').value;
                        if (!userCode[currentChallenge.id]) userCode[currentChallenge.id] = {};
                        userCode[currentChallenge.id][lang] = editor.getValue();
                    }
                });
                hideLoader();
                // Select first challenge by default
                selectChallenge(1);
            });
        }

        function setMonacoLang(lang) {
            if (!editor) return;
            const monacoLang = lang === 'javascript' ? 'javascript' : 'python';
            monaco.editor.setModelLanguage(editor.getModel(), monacoLang);
        }

        function onLangChange() {
            if (!currentChallenge) return;
            const lang = document.getElementById('langSelect').value;
            if (!userCode[currentChallenge.id]) userCode[currentChallenge.id] = {};
            if (!userCode[currentChallenge.id][lang]) {
                userCode[currentChallenge.id][lang] = currentChallenge.starterCode[lang];
            }
            editor.setValue(userCode[currentChallenge.id][lang]);
            setMonacoLang(lang);
            resetOutput();
        }

        function resetCode() {
            if (!currentChallenge) return;
            const lang = document.getElementById('langSelect').value;
            editor.setValue(currentChallenge.starterCode[lang]);
        }

        // ── RUN CODE ──
        async function runCode(isSubmit) {
            if (!currentChallenge || !editor) return;
            const lang = document.getElementById('langSelect').value;
            const code = editor.getValue();
            const testCases = isSubmit ? currentChallenge.testCases : [currentChallenge.testCases[0]];

            setRunStatus('running', 'Running…');
            document.getElementById('runBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;
            switchRightTab('tests', document.querySelectorAll('.cp-output-tabs .cp-tab')[0]);

            const results = [];
            let totalOutput = '';

            for (const tc of testCases) {
                try {
                    let { output, error } = await executeCode(lang, code, tc.input);
                    output = (output || '').trim();
                    const pass = output === tc.expected.trim();
                    totalOutput += output + '\n';
                    results.push({ tc, output, error, pass });
                } catch (e) {
                    results.push({ tc, output: '', error: String(e), pass: false });
                }
            }

            renderResults(results, isSubmit);
            document.getElementById('consoleBox').innerHTML = totalOutput
                ? `<span class="${results.every(r => r.pass) ? 'ok' : ''}">${escapeHtml(totalOutput.trim())}</span>`
                : '<span class="cp-console-empty">No output.</span>';

            document.getElementById('runBtn').disabled = false;
            document.getElementById('submitBtn').disabled = false;

            if (isSubmit) {
                stats.attempted++;
                if (results.every(r => r.pass)) {
                    stats.solved++;
                    stats.correct++;
                    if (!solved[currentChallenge.id]) {
                        solved[currentChallenge.id] = true;
                        localStorage.setItem('cp_solved', JSON.stringify(solved));
                        renderChallengeList();
                        // Award XP on first solve
                        if (typeof awardXP === 'function') awardXP(currentChallenge);
                    }
                }
                localStorage.setItem('cp_stats', JSON.stringify(stats));
                updateStats();
            }
        }

        async function executeCode(lang, code, input) {
            if (lang === 'python') {
                return await runPython(code, input);
            } else {
                return runJavaScript(code, input);
            }
        }

        // ── PYTHON via Pyodide ──
        let pyodideLoading = false;
        async function ensurePyodide() {
            if (pyodide) return;
            if (!pyodideLoading) {
                pyodideLoading = true;
                setRunStatus('running', 'Loading Python runtime…');
                pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/' });
            }
        }

        async function runPython(code, input) {
            await ensurePyodide();
            try {
                const output = await pyodide.runPythonAsync(`
import sys, io
_out = io.StringIO()
_in  = io.StringIO(${JSON.stringify(input + '\n')})
sys.stdout = _out
sys.stdin  = _in
try:
    exec(${JSON.stringify(code)})
except SystemExit:
    pass
except Exception as e:
    _out.write("ERROR: " + str(e) + "\\n")
finally:
    sys.stdout = sys.__stdout__
    sys.stdin  = sys.__stdin__
_out.getvalue()
`);
                const out = String(output);
                if (out.startsWith('ERROR: ')) return { output: '', error: out.slice(7) };
                return { output: out, error: null };
            } catch (e) {
                return { output: '', error: String(e) };
            }
        }

        // ── JAVASCRIPT ──
        function runJavaScript(code, input) {
            let output = '';
            let error = null;
            try {
                const fn = new Function('input', 'console', code);
                fn(input, { log: (...args) => { output += args.map(String).join(' ') + '\n'; } });
            } catch (e) {
                error = String(e);
            }
            return { output, error };
        }

        // ── RENDER RESULTS ──
        function renderResults(results, isSubmit) {
            const allPass = results.every(r => r.pass);
            setRunStatus(allPass ? 'pass' : 'fail',
                allPass
                    ? (isSubmit ? `All ${results.length} test cases passed!` : 'Test passed!')
                    : `${results.filter(r => !r.pass).length} of ${results.length} test(s) failed`
            );

            document.getElementById('testCaseList').innerHTML = results.map((r, i) => `
    <div class="cp-test-case">
      <div class="cp-test-header" onclick="toggleTest(this)">
        <div class="cp-test-header-left">
          <div class="cp-test-icon ${r.pass ? 'test-pass' : 'test-fail'}">
            <i data-lucide="${r.pass ? 'check' : 'x'}"></i>
          </div>
          Case ${i + 1}
        </div>
        <i data-lucide="chevron-down" style="width:13px;height:13px;color:var(--muted)"></i>
      </div>
      <div class="cp-test-body ${!r.pass ? 'open' : ''}">
        <div class="cp-test-row">
          <div class="cp-test-key">Input</div>
          <div class="cp-test-val">${escapeHtml(r.tc.input || '(none)')}</div>
        </div>
        <div class="cp-test-row">
          <div class="cp-test-key">Expected</div>
          <div class="cp-test-val">${escapeHtml(r.tc.expected)}</div>
        </div>
        <div class="cp-test-row">
          <div class="cp-test-key">Your Output</div>
          <div class="cp-test-val ${!r.pass ? 'wrong' : ''}">${escapeHtml(r.error ? 'ERROR: ' + r.error : (r.output || '(empty)'))}</div>
        </div>
      </div>
    </div>`).join('');
            lucide.createIcons();
        }

        function toggleTest(header) {
            const body = header.nextElementSibling;
            body.classList.toggle('open');
        }

        function setRunStatus(state, msg) {
            const el = document.getElementById('runStatus');
            el.className = 'cp-run-status status-' + state;
            const icons = { idle: 'clock', running: 'loader', pass: 'check-circle-2', fail: 'x-circle' };
            el.innerHTML = `<i data-lucide="${icons[state]}"></i> ${msg}`;
            lucide.createIcons();
        }

        function resetOutput() {
            setRunStatus('idle', 'Run your code to see results');
            document.getElementById('testCaseList').innerHTML = '';
            document.getElementById('consoleBox').innerHTML = '<span class="cp-console-empty">Run your code to see output…</span>';
        }

        // ── STATS ──
        function updateStats() {
            document.getElementById('statSolved').textContent = stats.solved;
            document.getElementById('statAttempted').textContent = stats.attempted;
            const acc = stats.attempted > 0 ? Math.round((stats.correct / stats.attempted) * 100) : 0;
            document.getElementById('statAccuracy').textContent = acc + '%';
            document.getElementById('statStreak').textContent = stats.streak || 0;
        }

        // ── TABS ──
        function switchLeftTab(name, btn) {
            document.querySelectorAll('.cp-left .cp-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.cp-left .cp-tab-panel').forEach(p => p.classList.remove('active'));
            if (btn) btn.classList.add('active');
            document.getElementById('tab-' + name)?.classList.add('active');
            lucide.createIcons();
        }

        function switchRightTab(name, btn) {
            document.querySelectorAll('.cp-output-tabs .cp-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.cp-output-panel').forEach(p => p.classList.remove('active'));
            if (btn) btn.classList.add('active');
            document.getElementById('tab-' + name)?.classList.add('active');
        }

        // ── UTILS ──
        function escapeHtml(s) {
            return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function hideLoader() {
            const l = document.getElementById('cpLoader');
            if (l) { l.style.opacity = '0'; setTimeout(() => l.remove(), 300); }
        }

        // ── XP SYSTEM ──
        let xp = parseInt(localStorage.getItem('cp_xp') || '0');
        const XP_EASY = 10, XP_MED = 25, XP_HARD = 50;
        function awardXP(challenge) {
            const gain = challenge.difficulty === 'easy' ? XP_EASY : challenge.difficulty === 'medium' ? XP_MED : XP_HARD;
            xp += gain;
            localStorage.setItem('cp_xp', xp);
            const el = document.getElementById('xpVal');
            el.textContent = xp;
            const badge = document.getElementById('xpBadge');
            badge.classList.remove('cp-xp-pop');
            void badge.offsetWidth;
            badge.classList.add('cp-xp-pop');
        }
        function initXP() { document.getElementById('xpVal').textContent = xp; }

        // (XP is awarded directly in runCode submit block below — no patch needed)

        // ── PROGRESSIVE HINTS ──
        const HINTS = {
            1: { hints: ['Print a string using print() or console.log()', 'The exact string is "Hello, World!"', 'print("Hello, World!")'] },
            2: { hints: ['Read two integers from separate lines', 'Use int(input()) for Python or parseInt() for JS', 'print(a + b)'] },
            3: { hints: ['A palindrome reads the same forwards and backwards', 'Convert to lowercase first, then compare with reverse', 'In Python: s == s[::-1]'] },
            4: { hints: ['Check divisibility using the modulo % operator', 'Check for both Fizz AND Buzz first (i%15)', 'Loop from 1 to n inclusive with range(1, n+1)'] },
            5: { hints: ['Start with a=0, b=1 and iterate', 'Each step: new_a=b, new_b=a+b', 'Collect values before updating: append a, then update'] },
            6: { hints: ['Use two pointers: lo=0, hi=n-1, mid=(lo+hi)//2', 'If nums[mid] < target, move lo up; else move hi down', 'Return index when nums[mid] == target, else -1'] },
            7: { hints: ['Use a stack — push opening brackets', 'For closing brackets, check if top of stack matches', 'If stack is empty at end, it is valid'] },
            8: { hints: ['This is Kadane\'s algorithm', 'Track current_sum = max(num, current_sum + num)', 'Track best = max(best, current_sum) at each step'] },
            9: { hints: ['Use a hash map to store seen values and their indices', 'For each number, check if (target - num) is in the map', 'If found, print the stored index and current index'] },
            10: { hints: ['Use a frequency counter (dictionary/object)', 'Sort by frequency descending, breaks ties alphabetically', 'In Python: sorted(items, key=lambda x: (-x[1], x[0]))'] }
        };

        let hintsShown = {};
        function renderHints() {
            if (!currentChallenge) return;
            const hData = HINTS[currentChallenge.id];
            if (!hData) return;
            const el = document.getElementById('hintsSection');
            if (!el) return;
            el.innerHTML = `
                <div class="cp-hint-list">
                    ${hData.hints.map((h, i) => `
                    <div class="cp-hint-item">
                        <button class="cp-hint-trigger" onclick="toggleHint(this,${i})">
                            <span><i data-lucide="lightbulb" style="width:12px;height:12px;color:var(--orange);margin-right:5px"></i>Hint ${i + 1}</span>
                            <i data-lucide="chevron-right"></i>
                        </button>
                        <div class="cp-hint-body" id="hint-${i}">${h}</div>
                    </div>`).join('')}
                </div>`;
            lucide.createIcons();
        }
        function toggleHint(btn, idx) {
            const body = document.getElementById('hint-' + idx);
            body?.classList.toggle('open');
        }

        // (Hints are rendered directly inside renderProblem — no patch needed)

        // ── LANGUAGE REFERENCE ──
        const REF = {
            python: [
                {
                    section: 'I/O', items: [
                        { code: 'input()', desc: 'Read a line from stdin as string' },
                        { code: 'int(input())', desc: 'Read integer from stdin' },
                        { code: 'print(x)', desc: 'Print value with newline' },
                        { code: 'print(a, b)', desc: 'Print multiple values space-separated' },
                    ]
                },
                {
                    section: 'Strings', items: [
                        { code: 's.lower()', desc: 'Lowercase string' },
                        { code: 's.split()', desc: 'Split by whitespace → list' },
                        { code: 's[::-1]', desc: 'Reverse a string' },
                        { code: 'len(s)', desc: 'Length of string' },
                        { code: '" ".join(lst)', desc: 'Join list with separator' },
                    ]
                },
                {
                    section: 'Lists', items: [
                        { code: 'lst.append(x)', desc: 'Add to end' },
                        { code: 'lst.pop()', desc: 'Remove and return last' },
                        { code: 'sorted(lst)', desc: 'Return sorted copy' },
                        { code: 'lst.sort()', desc: 'Sort in-place' },
                        { code: 'max(lst)', desc: 'Maximum value' },
                    ]
                },
                {
                    section: 'Algorithms', items: [
                        { code: 'O(1)', desc: 'Constant — hash map lookup' },
                        { code: 'O(log n)', desc: 'Logarithmic — binary search' },
                        { code: 'O(n)', desc: 'Linear — single loop' },
                        { code: 'O(n²)', desc: 'Quadratic — nested loops' },
                    ]
                }
            ],
            javascript: [
                {
                    section: 'I/O', items: [
                        { code: 'input', desc: 'Variable holding stdin (string)' },
                        { code: 'input.trim()', desc: 'Remove whitespace' },
                        { code: 'console.log(x)', desc: 'Print to output' },
                        { code: 'input.split("\\n")', desc: 'Split into lines' },
                    ]
                },
                {
                    section: 'Strings', items: [
                        { code: 's.toLowerCase()', desc: 'Lowercase string' },
                        { code: 's.split(" ")', desc: 'Split by space → array' },
                        { code: 's.split("").reverse().join("")', desc: 'Reverse string' },
                        { code: 's.length', desc: 'Length of string' },
                        { code: 'arr.join(", ")', desc: 'Join array to string' },
                    ]
                },
                {
                    section: 'Arrays', items: [
                        { code: '.push(x)', desc: 'Add to end' },
                        { code: '.pop()', desc: 'Remove and return last' },
                        { code: '.map(Number)', desc: 'Convert to numbers' },
                        { code: '.sort((a,b)=>a-b)', desc: 'Sort ascending' },
                        { code: 'Math.max(...arr)', desc: 'Maximum value' },
                    ]
                },
                {
                    section: 'Algorithms', items: [
                        { code: 'O(1)', desc: 'Constant — object/map lookup' },
                        { code: 'O(log n)', desc: 'Logarithmic — binary search' },
                        { code: 'O(n)', desc: 'Linear — single loop' },
                        { code: 'O(n²)', desc: 'Quadratic — nested loops' },
                    ]
                }
            ]
        };

        function renderRef(lang) {
            const data = REF[lang] || REF.python;
            document.getElementById('refContent').innerHTML = data.map(sec => `
                <div class="cp-ref-section">
                    <div class="cp-ref-section-header">${sec.section}</div>
                    ${sec.items.map(it => `
                    <div class="cp-ref-item">
                        <span class="cp-ref-code">${escapeHtml(it.code)}</span>
                        <span class="cp-ref-desc">${it.desc}</span>
                    </div>`).join('')}
                </div>`).join('');
        }
        function switchRef(lang, btn) {
            document.querySelectorAll('.cp-ref-lang-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            renderRef(lang);
        }

        // ── AI ASSISTANT ──
        let lastError = '';
        function aiQuick(text) { document.getElementById('aiInput').value = text; sendAiMessage(); }
        async function sendAiMessage() {
            const input = document.getElementById('aiInput');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            addAiMsg('user', text);
            const typingId = addAiTyping();
            switchRightTab('ai', document.querySelectorAll('.cp-output-tabs .cp-tab')[3]);

            const context = currentChallenge ? `Challenge: "${currentChallenge.title}" (${currentChallenge.difficulty})\nProblem: ${currentChallenge.description}\nUser code:\n${editor?.getValue() || ''}` : '';
            const prompt = context + '\n\nUser question: ' + text;

            try {
                const res = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (localStorage.getItem('token') || '') },
                    body: JSON.stringify({ message: prompt, context: 'code_practice' })
                });
                removeTyping(typingId);
                if (res.ok) {
                    const data = await res.json();
                    addAiMsg('assistant', data.reply || data.message || data.response || 'Sorry, I could not get a response.');
                } else {
                    addAiMsg('assistant', getFallbackAI(text));
                }
            } catch {
                removeTyping(typingId);
                addAiMsg('assistant', getFallbackAI(text));
            }
        }

        function getFallbackAI(text) {
            const t = text.toLowerCase();
            if (!currentChallenge) return 'Please select a challenge first, then I can help you better!';
            if (t.includes('hint')) return `Here\'s a hint for "${currentChallenge.title}": ${HINTS[currentChallenge.id]?.hints[0] || 'Think about the data structure that gives O(1) lookup.'}`;
            if (t.includes('error')) return 'Check your input parsing — make sure you are reading the right number of lines and converting types correctly (int/float vs string).';
            if (t.includes('algorithm')) return `For "${currentChallenge.title}", focus on the category: ${currentChallenge.category}. Think about what data structure best fits the problem.`;
            return 'Break the problem into small steps: 1) Parse input, 2) Apply the algorithm, 3) Print output. Which step is causing issues?';
        }

        let aiMsgId = 0;
        function addAiMsg(role, text) {
            const el = document.getElementById('aiMessages');
            const id = 'aim-' + (++aiMsgId);
            el.insertAdjacentHTML('beforeend', `<div class="cp-ai-msg ${role}" id="${id}">${escapeHtml(text)}</div>`);
            el.scrollTop = el.scrollHeight;
            return id;
        }
        function addAiTyping() {
            const el = document.getElementById('aiMessages');
            const id = 'aim-' + (++aiMsgId);
            el.insertAdjacentHTML('beforeend', `<div class="cp-ai-msg assistant" id="${id}"><div class="cp-ai-typing"><span></span><span></span><span></span></div></div>`);
            el.scrollTop = el.scrollHeight;
            return id;
        }
        function removeTyping(id) { document.getElementById(id)?.remove(); }

        // ── VISUALIZER ──
        let vizSteps = [], vizIdx = 0, vizTimer = null;
        async function openVisualizer() {
            if (!currentChallenge || !editor) return;
            document.getElementById('vizOverlay').classList.add('open');
            lucide.createIcons();
            const lang = document.getElementById('langSelect').value;
            if (lang !== 'python') {
                document.getElementById('vizCode').textContent = 'Visualizer supports Python only. Switch to Python 3.';
                document.getElementById('vizVars').innerHTML = '<div style="padding:12px;font-size:12px;color:var(--muted)">Switch to Python to visualize.</div>';
                return;
            }
            await ensurePyodide();
            const code = editor.getValue();
            const input = currentChallenge.testCases[0]?.input || '';
            await buildVizSteps(code, input);
            vizIdx = 0;
            renderVizStep();
        }
        function closeVisualizer() {
            document.getElementById('vizOverlay').classList.remove('open');
            clearInterval(vizTimer);
        }
        async function buildVizSteps(code, input) {
            vizSteps = [];
            try {
                const lines = code.split('\n');
                // Inject tracer
                const tracer = `
import sys, io, json as _json
_trace_steps = []
_vars_snap = {}
def _tracer(frame, event, arg):
    if event == 'line':
        snap = {k:repr(v) for k,v in frame.f_locals.items() if not k.startswith('_')}
        _trace_steps.append({'line': frame.f_lineno - _offset, 'vars': snap})
    return _tracer
_offset = ${tracer.split('\n').length}
_user_code = ${JSON.stringify(code)}
_out = io.StringIO()
_in = io.StringIO(${JSON.stringify(input + '\n')})
sys.stdout = _out; sys.stdin = _in
_ns = {'__builtins__': __builtins__}
try:
    sys.settrace(_tracer)
    exec(_user_code, _ns)
except: pass
finally: sys.settrace(None); sys.stdout = sys.__stdout__; sys.stdin = sys.__stdin__
_json.dumps({'steps': _trace_steps, 'lines': _user_code.split('\\n')})
`;
                const result = await pyodide.runPythonAsync(tracer);
                const data = JSON.parse(String(result));
                vizSteps = data.steps || [];
                window._vizLines = data.lines || code.split('\n');
            } catch (e) {
                vizSteps = [{ line: 0, vars: { error: String(e) } }];
                window._vizLines = code.split('\n');
            }
        }
        function renderVizStep() {
            const step = vizSteps[vizIdx];
            const lines = window._vizLines || [];
            document.getElementById('vizStepInfo').textContent = `Step ${vizIdx + 1} / ${vizSteps.length}`;
            document.getElementById('vizCode').innerHTML = lines.map((l, i) => {
                const active = step && i === step.line - 1;
                return `<div class="cp-viz-line ${active ? 'current' : ''}">${escapeHtml(l || ' ')}</div>`;
            }).join('');
            const varsEl = document.getElementById('vizVars');
            if (step && Object.keys(step.vars).length > 0) {
                varsEl.innerHTML = Object.entries(step.vars).map(([k, v]) =>
                    `<div class="cp-viz-var-row"><span class="cp-viz-var-name">${escapeHtml(k)}</span><span class="cp-viz-var-val">${escapeHtml(v)}</span></div>`
                ).join('');
            } else {
                varsEl.innerHTML = '<div class="cp-viz-var-row" style="color:var(--muted);font-size:12px;">No variables yet</div>';
            }
        }
        function vizStep(dir) { clearInterval(vizTimer); vizIdx = Math.max(0, Math.min(vizSteps.length - 1, vizIdx + dir)); renderVizStep(); }
        function vizRun() {
            clearInterval(vizTimer);
            vizTimer = setInterval(() => {
                if (vizIdx >= vizSteps.length - 1) { clearInterval(vizTimer); return; }
                vizIdx++; renderVizStep();
            }, 500);
        }

        // ── PYODIDE SCRIPT ──
        (function () {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js';
            document.head.appendChild(s);
        })();

        // ── START ──
        initXP();
        renderRef('python');
        init();
    </script>
</body>

</html>