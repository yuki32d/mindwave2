<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Updates — MindWave</title>
    <meta name="description" content="Grade updates, faculty feedback, and announcements for MindWave students.">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="student-theme.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="theme-init.js"></script>
    <script src="sidebar.js"></script>

    <style>
        /* ── Updates layout ──────────────────────────────────────── */
        .upd-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .upd-search {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 14px;
            flex: 1;
            min-width: 200px;
            max-width: 360px;
        }

        .upd-search svg {
            width: 15px;
            height: 15px;
            color: var(--muted);
            flex-shrink: 0;
        }

        .upd-search input {
            background: none;
            border: none;
            outline: none;
            color: var(--text);
            font-family: inherit;
            font-size: .88rem;
            width: 100%;
        }

        .upd-search input::placeholder {
            color: var(--muted);
        }

        .mark-all-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--muted);
            font-family: inherit;
            font-size: .82rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            white-space: nowrap;
        }

        .mark-all-btn svg {
            width: 14px;
            height: 14px;
        }

        .mark-all-btn:hover {
            background: rgba(99, 102, 241, .08);
            border-color: rgba(99, 102, 241, .4);
            color: #a5b4fc;
        }

        /* Unread notice bar */
        .unread-bar {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: rgba(99, 102, 241, .08);
            border: 1px solid rgba(99, 102, 241, .2);
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: .82rem;
            color: #a5b4fc;
        }

        .unread-bar.show {
            display: flex;
        }

        .unread-bar svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .unread-count {
            font-weight: 700;
        }

        /* Filter chips */
        .upd-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .fchip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--muted);
            font-family: inherit;
            font-size: .8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
        }

        .fchip svg {
            width: 13px;
            height: 13px;
        }

        .fchip .badge {
            display: inline-block;
            background: rgba(255, 255, 255, .1);
            color: var(--muted);
            border-radius: 999px;
            padding: 1px 7px;
            font-size: .7rem;
        }

        .fchip:hover {
            border-color: rgba(99, 102, 241, .4);
            color: #a5b4fc;
        }

        .fchip.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-color: transparent;
            color: #fff;
        }

        .fchip.active .badge {
            background: rgba(255, 255, 255, .25);
            color: #fff;
        }

        /* Timeline */
        .upd-timeline {
            position: relative;
        }

        .upd-timeline::before {
            content: '';
            position: absolute;
            left: 19px;
            top: 24px;
            bottom: 12px;
            width: 2px;
            background: linear-gradient(180deg, rgba(99, 102, 241, .5), rgba(139, 92, 246, .15), transparent);
            border-radius: 2px;
        }

        .upd-item {
            position: relative;
            padding-left: 58px;
            margin-bottom: 20px;
        }

        .upd-dot {
            position: absolute;
            left: 0;
            top: 12px;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            flex-shrink: 0;
        }

        .upd-dot svg {
            width: 16px;
            height: 16px;
        }

        .upd-dot.grade {
            background: rgba(34, 197, 94, .15);
            border: 2px solid rgba(34, 197, 94, .5);
            color: #4ade80;
        }

        .upd-dot.feedback {
            background: rgba(245, 158, 11, .15);
            border: 2px solid rgba(245, 158, 11, .5);
            color: #fcd34d;
        }

        .upd-dot.announcement {
            background: rgba(99, 102, 241, .15);
            border: 2px solid rgba(99, 102, 241, .4);
            color: #a5b4fc;
        }

        .upd-dot.goal {
            background: rgba(239, 68, 68, .15);
            border: 2px solid rgba(239, 68, 68, .4);
            color: #fca5a5;
        }

        /* Card */
        .upd-card {
            background: var(--card, rgba(255, 255, 255, .03));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px 20px;
            cursor: pointer;
            transition: border-color .2s, transform .2s, background .2s;
        }

        .upd-card:hover {
            border-color: rgba(99, 102, 241, .35);
            transform: translateX(3px);
        }

        .upd-card.unread {
            border-left: 3px solid #6366f1;
            background: rgba(99, 102, 241, .04);
        }

        .upd-card.grade.unread {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, .03);
        }

        .upd-card.feedback.unread {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, .03);
        }

        .upd-card-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }

        .upd-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 999px;
            font-size: .68rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .04em;
            flex-shrink: 0;
        }

        .upd-tag svg {
            width: 10px;
            height: 10px;
        }

        .tag-grade {
            background: rgba(34, 197, 94, .12);
            color: #4ade80;
        }

        .tag-feedback {
            background: rgba(245, 158, 11, .12);
            color: #fcd34d;
        }

        .tag-announcement {
            background: rgba(99, 102, 241, .12);
            color: #a5b4fc;
        }

        .tag-goal {
            background: rgba(239, 68, 68, .12);
            color: #fca5a5;
        }

        .upd-time {
            font-size: .72rem;
            color: var(--muted);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .upd-title {
            font-size: .95rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unread-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #6366f1;
            flex-shrink: 0;
        }

        .upd-body {
            font-size: .83rem;
            color: var(--muted);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        /* Grade score pill */
        .score-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 14px;
            border-radius: 999px;
            font-weight: 800;
            font-size: .92rem;
            margin-bottom: 8px;
        }

        .score-pill.high {
            background: rgba(34, 197, 94, .15);
            color: #4ade80;
        }

        .score-pill.medium {
            background: rgba(245, 158, 11, .15);
            color: #fcd34d;
        }

        .score-pill.low {
            background: rgba(239, 68, 68, .15);
            color: #fca5a5;
        }

        .upd-meta {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
        }

        .meta-chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: .72rem;
            color: var(--muted);
        }

        .meta-chip svg {
            width: 12px;
            height: 12px;
        }

        /* Empty state */
        .upd-empty {
            text-align: center;
            padding: 4rem 1rem;
            color: var(--muted);
        }

        .upd-empty svg {
            width: 48px;
            height: 48px;
            opacity: .25;
            margin-bottom: 16px;
        }

        .upd-empty h3 {
            margin: 0 0 8px;
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--text);
        }

        .upd-empty p {
            margin: 0;
            font-size: .83rem;
        }

        /* Date separator */
        .date-sep {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 24px 0 16px;
            padding-left: 58px;
        }

        .date-sep-line {
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .date-sep-label {
            font-size: .72rem;
            color: var(--muted);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .08em;
            white-space: nowrap;
        }

        /* Skeleton */
        .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, .05) 25%, rgba(255, 255, 255, .1) 50%, rgba(255, 255, 255, .05) 75%);
            background-size: 200% 100%;
            animation: skelAnim 1.3s infinite;
            border-radius: 8px;
        }

        @keyframes skelAnim {
            0% {
                background-position: 200% 0
            }

            100% {
                background-position: -200% 0
            }
        }
    </style>
</head>

<body>
    <div class="mw-app" id="mwApp">

        <!-- SIDEBAR -->
        <aside class="mw-sidebar">
            <div class="mw-logo">
                <div class="mw-logo-icon"><i data-lucide="brain-circuit"></i></div>
                <span class="mw-logo-text">MindWave</span>
                <span class="mw-logo-badge">Student</span>
            </div>
            <div class="mw-sidebar-nav">
                <nav class="mw-nav-section">
                    <div class="mw-nav-label">Main</div>
                    <a href="homepage.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="layout-dashboard"></i></span> Dashboard</a>
                    <a href="student-courses.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="book-open"></i></span> My Courses</a>
                    <a href="student-timetable.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="calendar-days"></i></span> Timetable</a>
                    <a href="student-performance.html" class="mw-nav-item active"><span class="mw-nav-icon"><i
                                data-lucide="bar-chart-2"></i></span> Performance</a>
                    <a href="student-leaderboard.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="trophy"></i></span> Leaderboard</a>
                </nav>
                <div class="mw-divider"></div>
                <nav class="mw-nav-section">
                    <div class="mw-nav-label">Engage</div>
                    <a href="student-game.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="gamepad-2"></i></span> Play Games</a>
                    <a href="student-community.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="users"></i></span> Community</a>
                    <a href="student-achievements.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="award"></i></span> Achievements</a>
                    <a href="student-upcoming-events.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="megaphone"></i></span> Events</a>
                </nav>
                <div class="mw-divider"></div>
                <nav class="mw-nav-section">
                    <div class="mw-nav-label">Tools</div>
                    <a href="student-code-practice.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="terminal"></i></span> Code Practice</a>
                    <a href="student-ai-tutor.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="bot"></i></span> AI Tutor</a>
                    <a href="student-github.html" class="mw-nav-item">
                        <span class="mw-nav-icon"><i data-lucide="github"></i></span> GitHub Projects
                    </a>
                    <a href="student-live-meeting.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="video"></i></span> Web Conf</a>
                    <a href="student-reports.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="file-text"></i></span> Reports</a>
                    <a href="student-settings.html" class="mw-nav-item"><span class="mw-nav-icon"><i
                                data-lucide="settings"></i></span> Settings</a>
                </nav>
                <div class="mw-divider"></div>
                <nav class="mw-nav-section">
                    <button id="signOutBtn" class="mw-nav-item"
                        style="width:100%;background:none;border:none;cursor:pointer;text-align:left;color:var(--red,#ff5c5c);">
                        <span class="mw-nav-icon"><i data-lucide="log-out"></i></span> Logout
                    </button>
                </nav>
            </div>
            <div class="mw-sidebar-footer">
                <div id="profileToggle" class="mw-user-card" style="position:relative;">
                    <div class="mw-avatar" id="avatarInitials">--</div>
                    <div>
                        <div class="mw-user-name" id="sidebarUserName">Loading…</div>
                        <div class="mw-user-role">Student</div>
                    </div>
                    <span class="mw-user-more">⋯</span>
                    <div id="profileDropdown" class="mw-profile-dropdown">
                        <div class="mw-profile-dropdown-header">
                            <div class="name" id="dropdownUserName">Student</div>
                            <div class="role">Student · MindWave</div>
                        </div>
                        <a href="student-profile.html"><i data-lucide="user"></i> My Profile</a>
                        <a href="student-settings.html"><i data-lucide="settings"></i> Settings</a>
                        <a href="student-notifications.html"><i data-lucide="bell"></i> Notifications</a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN -->
        <div class="mw-main">
            <header class="mw-topbar">
                <button class="mw-hamburger" id="sidebarToggle"
                    aria-label="Toggle sidebar"><span></span><span></span><span></span></button>
                <div class="mw-breadcrumb">Performance / <span>Updates</span></div>
                <div class="mw-topbar-actions">
                    <div class="mw-notif-wrap">
                        <div class="mw-icon-btn" id="notificationBtn"><i data-lucide="bell"></i><span
                                class="mw-notif-dot hidden" id="notificationBadge"></span></div>
                        <div class="mw-notif-dropdown" id="notificationDropdown"></div>
                    </div>
                    <div class="mw-icon-btn" id="settingsBtn"><i data-lucide="settings"></i></div>
                    <button class="mw-theme-toggle" id="themeToggle" aria-label="Toggle theme">
                        <span class="mw-toggle-moon"><i data-lucide="moon"></i></span>
                        <span class="mw-toggle-sun"><i data-lucide="sun"></i></span>
                    </button>
                </div>
            </header>

            <div class="mw-content">

                <!-- Page header -->
                <div style="margin-bottom:20px">
                    <div style="font-size:1.5rem;font-weight:800;color:var(--text);margin-bottom:4px">Updates</div>
                    <div style="font-size:.85rem;color:var(--muted)">Grade updates, faculty feedback, and announcements
                    </div>
                </div>

                <!-- Unread notice bar -->
                <div class="unread-bar" id="unreadBar">
                    <i data-lucide="bell-ring"></i>
                    <span>You have <strong class="unread-count" id="unreadCount">0</strong> unread update(s)</span>
                </div>

                <!-- Toolbar: search + mark all read -->
                <div class="upd-toolbar">
                    <div class="upd-search">
                        <i data-lucide="search"></i>
                        <input type="text" id="searchInput" placeholder="Search updates…" oninput="applyFilters()">
                    </div>
                    <button class="mark-all-btn" onclick="markAllRead()">
                        <i data-lucide="check-check"></i> Mark All Read
                    </button>
                </div>

                <!-- Filter chips -->
                <div class="upd-filters" id="filterBar">
                    <button class="fchip active" data-filter="all" onclick="setFilter('all', this)">
                        <i data-lucide="layers"></i> All <span class="badge" id="cnt-all">0</span>
                    </button>
                    <button class="fchip" data-filter="grade" onclick="setFilter('grade', this)">
                        <i data-lucide="star"></i> Grades <span class="badge" id="cnt-grade">0</span>
                    </button>
                    <button class="fchip" data-filter="feedback" onclick="setFilter('feedback', this)">
                        <i data-lucide="message-square"></i> Feedback <span class="badge" id="cnt-feedback">0</span>
                    </button>
                    <button class="fchip" data-filter="announcement" onclick="setFilter('announcement', this)">
                        <i data-lucide="megaphone"></i> Announcements <span class="badge" id="cnt-announcement">0</span>
                    </button>
                </div>

                <!-- Timeline (rendered by JS) -->
                <div class="upd-timeline" id="updTimeline">
                    <!-- skeleton -->
                    <div id="loadSkeleton" style="display:flex;flex-direction:column;gap:16px">
                        <div class="upd-item" style="padding-left:58px">
                            <div class="skeleton" style="height:100px;border-radius:16px"></div>
                        </div>
                        <div class="upd-item" style="padding-left:58px">
                            <div class="skeleton" style="height:80px;border-radius:16px"></div>
                        </div>
                        <div class="upd-item" style="padding-left:58px">
                            <div class="skeleton" style="height:90px;border-radius:16px"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Logout modal -->
    <div id="logoutModal" class="mw-logout-overlay">
        <div class="mw-logout-modal">
            <div class="mw-logout-icon"><i data-lucide="log-out"></i></div>
            <h3 class="mw-logout-title">Sign out?</h3>
            <p class="mw-logout-sub">You'll need to log back in to access your dashboard.</p>
            <div class="mw-logout-actions">
                <button class="mw-logout-cancel"
                    onclick="document.getElementById('logoutModal').classList.remove('active')">Cancel</button>
                <button class="mw-logout-confirm" onclick="doLogout()"><i data-lucide="log-out"></i> Sign Out</button>
            </div>
        </div>
    </div>

    <style>
        .mw-logout-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .5);
            backdrop-filter: blur(6px);
            z-index: 9999;
            align-items: center;
            justify-content: center
        }

        .mw-logout-overlay.active {
            display: flex
        }

        .mw-logout-modal {
            background: var(--card, #1c1c2e);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: .75rem;
            box-shadow: 0 24px 64px rgba(0, 0, 0, .5)
        }

        .mw-logout-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(255, 92, 92, .12);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff5c5c
        }

        .mw-logout-icon svg {
            width: 28px;
            height: 28px
        }

        .mw-logout-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 .5rem;
            color: var(--text, #fff)
        }

        .mw-logout-sub {
            font-size: .875rem;
            color: var(--text-muted, #aaa);
            margin: 0 0 2rem;
            line-height: 1.5
        }

        .mw-logout-actions {
            display: flex;
            gap: .75rem;
            width: 100%
        }

        .mw-logout-cancel,
        .mw-logout-confirm {
            flex: 1;
            padding: .75rem 1rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: .9rem;
            cursor: pointer;
            border: none;
            transition: all .2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px
        }

        .mw-logout-cancel {
            background: rgba(255, 255, 255, .06);
            color: var(--text, #fff)
        }

        .mw-logout-confirm {
            background: #ff5c5c;
            color: #fff
        }
    </style>

    <script>
        const TOKEN = localStorage.getItem('token') || localStorage.getItem('mindwave_token');
        if (!TOKEN) window.location.replace('marketing-site/student-login.html');

        const API = window.location.hostname === 'localhost' ? 'http://localhost:8081' : '';
        const H = { 'Authorization': 'Bearer ' + TOKEN };

        let allUpdates = [];
        let activeFilter = 'all';
        let searchQuery = '';

        // ── Helpers ────────────────────────────────────────────────
        function timeAgo(ts) {
            const s = Math.floor((Date.now() - new Date(ts)) / 1000);
            if (s < 60) return 'Just now';
            if (s < 3600) return Math.floor(s / 60) + 'm ago';
            if (s < 86400) return Math.floor(s / 3600) + 'h ago';
            if (s < 86400 * 7) return Math.floor(s / 86400) + 'd ago';
            return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function dayLabel(ts) {
            const d = new Date(ts);
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const diff = Math.floor((today - d) / 86400000);
            if (diff === 0) return 'Today';
            if (diff === 1) return 'Yesterday';
            return d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        }

        function typeIcon(t) {
            return { grade: 'star', feedback: 'message-square', announcement: 'megaphone', goal: 'target' }[t] || 'bell';
        }

        function scoreHtml(content, type) {
            if (type !== 'grade') return '';
            const m = content.match(/(\d+)\s*\/\s*(\d+)/);
            if (!m) return '';
            const pct = Math.round((m[1] / m[2]) * 100);
            const cls = pct >= 85 ? 'high' : pct >= 60 ? 'medium' : 'low';
            return `<div class="score-pill ${cls}"><i data-lucide="star" style="width:12px;height:12px"></i>${m[1]}/${m[2]} (${pct}%)</div>`;
        }

        function cardHtml(u) {
            const t = u.type || 'announcement';
            const unread = !u.read;
            return `
        <div class="upd-item" data-type="${t}" data-id="${u.id}" data-read="${u.read ? '1' : '0'}">
          <div class="upd-dot ${t}"><i data-lucide="${typeIcon(t)}"></i></div>
          <div class="upd-card ${t} ${unread ? 'unread' : ''}" onclick="markRead('${u.id}', this)">
            <div class="upd-card-top">
              <span class="upd-tag tag-${t}">
                <i data-lucide="${typeIcon(t)}"></i>
                ${t === 'grade' ? 'Grade Posted' : t === 'feedback' ? 'Faculty Feedback' : t === 'goal' ? 'Goal Update' : 'Announcement'}
              </span>
              <span class="upd-time">${timeAgo(u.timestamp)}</span>
            </div>
            <div class="upd-title">
              ${u.title}
              ${unread ? '<span class="unread-dot"></span>' : ''}
            </div>
            ${scoreHtml(u.content || '', t)}
            <div class="upd-body">${u.content || ''}</div>
            <div class="upd-meta">
              ${u.meta?.subject ? `<span class="meta-chip"><i data-lucide="book-open"></i>${u.meta.subject}</span>` : ''}
              ${u.meta?.teacher ? `<span class="meta-chip"><i data-lucide="user"></i>${u.meta.teacher}</span>` : ''}
            </div>
          </div>
        </div>`;
        }

        // ── Render ─────────────────────────────────────────────────
        function renderTimeline(data) {
            const tl = document.getElementById('updTimeline');

            if (!data.length) {
                tl.innerHTML = `
          <div class="upd-empty">
            <div><i data-lucide="bell-off"></i></div>
            <h3>No updates yet</h3>
            <p>You're all caught up! New grades, feedback, and announcements will appear here.</p>
          </div>`;
                lucide.createIcons();
                return;
            }

            // Group by day
            let html = '';
            let lastDay = '';
            for (const u of data) {
                const day = dayLabel(u.timestamp);
                if (day !== lastDay) {
                    html += `<div class="date-sep"><div class="date-sep-line"></div><span class="date-sep-label">${day}</span><div class="date-sep-line"></div></div>`;
                    lastDay = day;
                }
                html += cardHtml(u);
            }
            tl.innerHTML = html;
            lucide.createIcons();
        }

        function applyFilters() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allUpdates.filter(u => {
                const typeMatch = activeFilter === 'all' || u.type === activeFilter;
                const searchMatch = !searchQuery || (u.title + ' ' + (u.content || '')).toLowerCase().includes(searchQuery);
                return typeMatch && searchMatch;
            });
            renderTimeline(filtered);
        }

        function updateCounts() {
            const types = ['grade', 'feedback', 'announcement'];
            document.getElementById('cnt-all').textContent = allUpdates.length;
            types.forEach(t => {
                const el = document.getElementById('cnt-' + t);
                if (el) el.textContent = allUpdates.filter(u => u.type === t).length;
            });

            const unreadN = allUpdates.filter(u => !u.read).length;
            const bar = document.getElementById('unreadBar');
            document.getElementById('unreadCount').textContent = unreadN;
            unreadN > 0 ? bar.classList.add('show') : bar.classList.remove('show');
        }

        function setFilter(type, btn) {
            activeFilter = type;
            document.querySelectorAll('.fchip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            applyFilters();
        }

        // ── API actions ────────────────────────────────────────────
        async function markRead(id, cardEl) {
            if (!cardEl.classList.contains('unread')) return;
            cardEl.classList.remove('unread');
            const dot = cardEl.querySelector('.unread-dot'); if (dot) dot.remove();
            // update local state
            const u = allUpdates.find(x => x.id === id);
            if (u) u.read = true;
            updateCounts();
            // persist to server
            try { await fetch(API + '/api/student/updates/' + id + '/read', { method: 'PATCH', headers: H }); } catch { }
        }

        async function markAllRead() {
            const unread = allUpdates.filter(u => !u.read);
            if (!unread.length) return;

            // Optimistic UI update
            unread.forEach(u => { u.read = true; });
            document.querySelectorAll('.upd-card.unread').forEach(el => {
                el.classList.remove('unread');
                const dot = el.querySelector('.unread-dot'); if (dot) dot.remove();
            });
            updateCounts();

            // Persist all
            await Promise.all(unread.map(u =>
                fetch(API + '/api/student/updates/' + u.id + '/read', { method: 'PATCH', headers: H }).catch(() => { })
            ));
        }

        // ── Load ───────────────────────────────────────────────────
        async function loadUpdates() {
            try {
                const r = await fetch(API + '/api/student/updates', { headers: H });
                if (!r.ok) throw new Error('api');
                allUpdates = await r.json();
            } catch {
                allUpdates = [];
            }
            document.getElementById('loadSkeleton').remove();
            updateCounts();
            applyFilters();
        }

        // ── Profile init ───────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', () => {
            const fn = localStorage.getItem('firstName') || '';
            const ln = localStorage.getItem('lastName') || '';
            const full = [fn, ln].filter(Boolean).join(' ') || 'Student';
            const init = ((fn[0] || '') + (ln[0] || '')).toUpperCase() || 'ST';

            document.querySelectorAll('#sidebarUserName,#dropdownUserName').forEach(el => el && (el.textContent = fn || full));
            const av = document.getElementById('avatarInitials'); if (av) av.textContent = init;

            const pt = document.getElementById('profileToggle'), pd = document.getElementById('profileDropdown');
            if (pt && pd) {
                pt.addEventListener('click', () => pd.style.display = pd.style.display === 'flex' ? 'none' : 'flex');
                document.addEventListener('click', e => { if (!pt.contains(e.target) && !pd.contains(e.target)) pd.style.display = 'none'; });
            }
            const sob = document.getElementById('signOutBtn');
            if (sob) sob.addEventListener('click', () => document.getElementById('logoutModal').classList.add('active'));

            const tt = document.getElementById('themeToggle');
            if (tt) tt.addEventListener('click', () => {
                const d = document.documentElement.getAttribute('data-theme') === 'dark';
                document.documentElement.setAttribute('data-theme', d ? 'light' : 'dark');
                localStorage.setItem('mw_theme', d ? 'light' : 'dark');
            });

            lucide.createIcons();
            loadUpdates();
        });

        function doLogout() {
            ['token', 'mindwave_token', 'firstName', 'lastName', 'email', 'role'].forEach(k => localStorage.removeItem(k));
            window.location.replace('marketing-site/student-login.html');
        }
    </script>

    <script src="auth-guard.js"></script>
</body>

</html>