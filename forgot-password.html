<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password – Mindwave</title>
    <style>
        :root {
            --blue: #0f62fe;
            --purple: #8a3ffc;
            --dark: #03040a;
            --card-bg: rgba(15, 17, 27, 0.88);
            --border: rgba(255, 255, 255, 0.1);
            --text: #f5f6fb;
            --muted: #9ea4b6;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: "Inter", "Segoe UI", Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at top right, rgba(143, 115, 255, 0.35), transparent 55%),
                        radial-gradient(circle at bottom left, rgba(15, 98, 254, 0.35), transparent 50%),
                        #02030a;
            color: var(--text);
            padding: 32px;
        }
        .auth-shell {
            width: min(960px, 100%);
            background: rgba(3, 5, 15, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 28px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            overflow: hidden;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
        }
        .auth-hero {
            padding: 48px;
            background: linear-gradient(160deg, rgba(15, 98, 254, 0.25), rgba(138, 63, 252, 0.25));
            border-right: 1px solid rgba(255, 255, 255, 0.08);
        }
        .auth-card {
            padding: 48px 40px;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        h1, h2 {
            margin: 0;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group label {
            font-size: 14px;
            color: var(--muted);
        }
        .form-group input {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text);
            font-size: 16px;
        }
        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.55);
        }
        .primary-btn {
            border: none;
            border-radius: 16px;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(120deg, var(--blue), var(--purple));
            cursor: pointer;
            transition: transform 200ms ease, box-shadow 200ms ease;
        }
        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(15, 98, 254, 0.35);
        }
        .auth-links {
            font-size: 14px;
            text-align: center;
        }
        .auth-links a {
            color: var(--text);
            text-decoration: none;
        }
        .auth-links a:hover {
            color: var(--blue);
        }
        @media (max-width: 720px) {
            .auth-card, .auth-hero {
                padding: 32px;
            }
        }
    </style>
</head>
<body>
    <div class="auth-shell">
        <section class="auth-hero">
            <p style="letter-spacing: 0.3em; text-transform: uppercase; font-size: 12px; color: var(--muted);">Mindwave</p>
            <h1>Reset credentials</h1>
            <p style="color: var(--muted); line-height: 1.6;">Confirm your campus email and set a new password. We’ll update the local session data so you can sign back in immediately.</p>
        </section>
        <section class="auth-card">
            <div>
                <h2>Forgot password</h2>
                <p style="color: var(--muted); margin: 6px 0 0;">Enter your campus email to receive a 6-digit code.</p>
            </div>
            <form id="request-form">
                <div class="role-selection">
                    <label><input type="radio" name="role" value="student" checked> Student</label>
                    <label><input type="radio" name="role" value="admin"> Admin</label>
                </div>
                <div class="form-group">
                    <label for="reset-email">Campus Email</label>
                    <input type="email" id="reset-email" placeholder="student.mca25@cmrit.ac.in" required>
                </div>
                <button type="submit" class="primary-btn">Send verification code</button>
            </form>
            <form id="reset-form" style="display:none;">
                <div class="form-group">
                    <label for="verification-code">Verification Code</label>
                    <input type="text" id="verification-code" maxlength="6" placeholder="Enter 6-digit code" required>
                </div>
                <div class="form-group">
                    <label for="reset-password">New Password</label>
                    <input type="password" id="reset-password" placeholder="Create new password" minlength="6" required>
                </div>
                <button type="submit" class="primary-btn">Update password</button>
            </form>
            <div class="auth-links">
                Remembered your password? <a href="login.html">Back to login</a>
            </div>
        </section>
    </div>
    <script>
        const devHost = window.location.hostname || 'localhost';
        let API_BASE = window.location.origin;
        (async () => {
            if (window.location.protocol === 'file:') {
                const host = '127.0.0.1';
                const ports = [8080, 8081, 8082, 8083, 8084];
                for (const p of ports) {
                    try {
                        const res = await fetch(`http://${host}:${p}/`);
                        if (res.ok) { API_BASE = `http://${host}:${p}`; break; }
                    } catch {}
                }
            }
        })();
        const STUDENT_EMAIL_REGEX = /\.mca25@cmrit\.ac\.in$/i;
        const ADMIN_EMAIL_REGEX = /\.mca@cmrit\.ac\.in$/i;

        function updatePlaceholder() {
            const role = document.querySelector('input[name="role"]:checked').value;
            const emailInput = document.getElementById('reset-email');
            emailInput.placeholder = role === 'student'
                ? 'student.mca25@cmrit.ac.in'
                : 'admin.mca@cmrit.ac.in';
        }

        updatePlaceholder();

        document.querySelectorAll('input[name="role"]').forEach(radio => {
            radio.addEventListener('change', updatePlaceholder);
        });

        const requestForm = document.getElementById('request-form');
        const resetForm = document.getElementById('reset-form');
        const emailInput = document.getElementById('reset-email');
        const verificationInput = document.getElementById('verification-code');
        const passwordInput = document.getElementById('reset-password');

        let activeEmail = '';

        requestForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = emailInput.value.trim().toLowerCase();

            if (!(STUDENT_EMAIL_REGEX.test(email) || ADMIN_EMAIL_REGEX.test(email))) {
                alert('Invalid Email Address. Only campus emails are accepted.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/password/forgot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await response.json();
                if (!data.ok) {
                    alert(data.message || 'Unable to send verification code.');
                    return;
                }
                activeEmail = email;
                alert('Verification code sent! Please check your email (console log in dev).');
                resetForm.style.display = 'flex';
                requestForm.querySelector('button').disabled = true;
                emailInput.disabled = true;
            } catch (error) {
                console.error(error);
                alert('Unable to send verification code. Please try again.');
            }
        });

        resetForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const code = verificationInput.value.trim();
            const newPassword = passwordInput.value.trim();

            if (!code || code.length !== 6) {
                alert('Please enter the 6-digit verification code.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/password/reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: activeEmail, code, newPassword })
                });
                const data = await response.json();
                if (!data.ok) {
                    alert(data.message || 'Unable to reset password.');
                    return;
                }
                alert('Password updated. Please log in with your new credentials.');
                window.location.href = 'login.html';
            } catch (error) {
                console.error(error);
                alert('Unable to reset password. Please try again.');
            }
        });
    </script>
</body>
</html>



