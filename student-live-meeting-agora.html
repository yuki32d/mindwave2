<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Meeting - Student | MindWave</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Agora Web SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: white;
        }

        .meeting-header {
            display: none;
            /* Hidden - using modal instead */
        }

        .meeting-info h2 {
            margin: 0;
            font-size: 20px;
        }

        .meeting-code {
            color: #00d4ff;
            font-size: 18px;
        }

        .meeting-container {
            width: 100%;
            height: 100vh;
            background: #000;
            position: relative;
            padding-top: 0;
            /* Removed top padding since header is hidden */
        }

        .local-video {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border-radius: 12px;
            overflow: hidden;
            z-index: 10;
            background: #1a1a1a;
            border: 2px solid #00d4ff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remote-videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            padding: 40px 60px;
            height: 100vh;
            overflow-y: auto;
            max-width: 1600px;
            margin: 0 auto;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE and Edge */
        }

        .remote-videos-grid::-webkit-scrollbar {
            display: none;
            /* Chrome, Safari, Opera */
        }

        .remote-video {
            border-radius: 16px;
            overflow: hidden;
            background: #1a1a1a;
            position: relative;
            min-height: 280px;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 16 / 9;
            max-height: 600px;
        }

        .participant-name {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .faculty-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: 600;
        }

        .controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .controls button {
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .controls button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .controls button.active {
            background: #00d4ff;
            color: #000;
        }

        .controls button.danger {
            background: #ff4444;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Avatar Initials (Google Meet/Zoom style) */
        .avatar-initials {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 700;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 15;
            /* Higher than video */
        }

        .local-video .avatar-initials {
            width: 80px;
            height: 80px;
            font-size: 32px;
        }

        .avatar-initials.hidden {
            display: none;
        }

        /* Meeting Code Badge */
        .meeting-code-badge {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .meeting-code-label {
            color: #9ea4b6;
            font-size: 12px;
        }

        .meeting-code-value {
            color: #00d4ff;
            font-weight: 600;
            letter-spacing: 1px;
        }
    </style>
</head>

<body>
    <div class="meeting-header">
        <div class="meeting-info">
            <h2>Live Meeting</h2>
            <div class="meeting-code">Meeting Code: <span id="meetingCodeDisplay"></span></div>
        </div>
    </div>

    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
        <p>Joining meeting...</p>
    </div>

    <!-- Meeting Code Badge -->
    <div class="meeting-code-badge" id="meetingCodeBadge">
        <span class="meeting-code-label">Meeting Code:</span>
        <span class="meeting-code-value" id="badgeMeetingCode"></span>
    </div>

    <div class="meeting-container" id="meetingContainer" style="display: none;">
        <div class="local-video" id="localVideo">
            <div class="avatar-initials hidden" id="localAvatar"></div>
        </div>
        <div class="remote-videos-grid" id="remoteVideos"></div>

        <div class="controls">
            <button id="muteBtn" onclick="toggleMute()">
                ðŸŽ¤ <span id="muteText">Mute</span>
            </button>
            <button id="videoBtn" onclick="toggleVideo()">
                ðŸ“¹ <span id="videoText">Stop Video</span>
            </button>
            <button class="danger" onclick="leaveMeeting()">
                ðŸ“ž Leave
            </button>
        </div>
    </div>

    <script>
        // Get meeting code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const meetingCode = urlParams.get('code');

        if (!meetingCode) {
            alert('No meeting code provided');
            window.location.href = 'student-community.html';
        }

        // Authentication
        const token = localStorage.getItem('token');
        const userName = localStorage.getItem('userName') || 'Student';
        const userEmail = localStorage.getItem('userEmail') || '';

        if (!token) {
            window.location.href = 'student-login.html';
        }

        // Agora client and tracks
        let agoraClient = null;
        let localAudioTrack = null;
        let localVideoTrack = null;
        let remoteUsers = {};
        let isMuted = false;
        let isVideoOff = false;

        // Helper function to get initials from name
        function getInitials(name) {
            if (!name) return '?';

            const words = name.trim().split(' ');
            if (words.length === 1) {
                // Single word: take first letter
                return words[0].charAt(0).toUpperCase();
            } else {
                // Multiple words: take first letter of first and last word
                return (words[0].charAt(0) + words[words.length - 1].charAt(0)).toUpperCase();
            }
        }

        // Helper function to generate consistent color from name
        function getAvatarColor(name) {
            const colors = [
                '#FF6B6B', // Red
                '#4ECDC4', // Teal
                '#45B7D1', // Blue
                '#FFA07A', // Light Salmon
                '#98D8C8', // Mint
                '#F7DC6F', // Yellow
                '#BB8FCE', // Purple
                '#85C1E2', // Sky Blue
                '#F8B739', // Orange
                '#52B788', // Green
                '#E76F51', // Burnt Orange
                '#8E7CC3', // Lavender
            ];

            // Generate consistent color based on name
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }

            return colors[Math.abs(hash) % colors.length];
        }

        // Initialize and join meeting
        async function init() {
            const API_BASE = window.location.hostname === 'localhost'
                ? 'http://localhost:8081'
                : 'https://mindwave2.onrender.com';

            try {
                // Display meeting code
                document.getElementById('meetingCodeDisplay').textContent = meetingCode;

                // Call backend to get Agora credentials
                const response = await fetch(`${API_BASE}/api/meetings/${meetingCode}/join-agora`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        studentName: userName,
                        studentEmail: userEmail
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('âœ… Agora credentials received:', data);

                    // Display meeting code
                    document.getElementById('meetingCodeDisplay').textContent = meetingCode;
                    document.getElementById('badgeMeetingCode').textContent = meetingCode;

                    // Initialize Agora client
                    agoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });

                    // Set up event listeners
                    agoraClient.on('user-published', handleUserPublished);
                    agoraClient.on('user-unpublished', handleUserUnpublished);
                    agoraClient.on('user-left', handleUserLeft);

                    // Join channel
                    await agoraClient.join(
                        data.appId,
                        data.channelName,
                        data.token,
                        data.uid
                    );

                    console.log('âœ… Joined Agora channel as AUDIENCE');

                    // Video resolution configurations (16:9 aspect ratio)
                    const videoResolution = localStorage.getItem('videoResolution') || '720p';
                    const videoConfigs = {
                        '1080p': {
                            width: { ideal: 1920, max: 1920 },
                            height: { ideal: 1080, max: 1080 },
                            frameRate: 30
                        },
                        '720p': {
                            width: { ideal: 1280, max: 1280 },
                            height: { ideal: 720, max: 720 },
                            frameRate: 30
                        },
                        '360p': {
                            width: { ideal: 640, max: 640 },
                            height: { ideal: 360, max: 360 },
                            frameRate: 24
                        }
                    };

                    // Create local tracks with specified resolution
                    localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                    localVideoTrack = await AgoraRTC.createCameraVideoTrack(videoConfigs[videoResolution]);

                    // Play local video
                    localVideoTrack.play('localVideo');

                    // Ensure avatar element exists after video plays (Agora may modify the container)
                    let localAvatar = document.getElementById('localAvatar');
                    if (!localAvatar) {
                        // Create avatar if it doesn't exist
                        localAvatar = document.createElement('div');
                        localAvatar.id = 'localAvatar';
                        localAvatar.className = 'avatar-initials hidden';
                        document.getElementById('localVideo').appendChild(localAvatar);
                    }

                    // Set up local avatar with initials and color
                    localAvatar.textContent = getInitials(userName);
                    localAvatar.style.backgroundColor = getAvatarColor(userName);

                    // Publish tracks (students can also publish in this setup)
                    await agoraClient.publish([localAudioTrack, localVideoTrack]);

                    console.log('âœ… Published local tracks');

                    // Hide loading, show meeting
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('meetingContainer').style.display = 'block';

                } else {
                    console.error('Failed to join Agora meeting:', data.error);
                    alert('Failed to join meeting. Please check the meeting code.');
                    window.location.href = 'student-community.html';
                }
            } catch (error) {
                console.error('Error joining Agora meeting:', error);
                alert('Failed to join meeting. Please try again.');
                window.location.href = 'student-community.html';
            }
        }

        // Handle remote user published
        async function handleUserPublished(user, mediaType) {
            console.log('ðŸ‘¤ User published:', user.uid, mediaType);

            await agoraClient.subscribe(user, mediaType);

            if (mediaType === 'video') {
                const remoteVideoTrack = user.videoTrack;

                // Create container for remote video
                let playerContainer = document.getElementById(`player-${user.uid}`);
                if (!playerContainer) {
                    playerContainer = document.createElement('div');
                    playerContainer.id = `player-${user.uid}`;
                    playerContainer.className = 'remote-video';

                    const nameTag = document.createElement('div');
                    nameTag.className = 'participant-name';
                    // First user is likely faculty
                    const isFaculty = Object.keys(remoteUsers).length === 0;
                    nameTag.innerHTML = isFaculty
                        ? `Faculty <span class="faculty-badge">HOST</span>`
                        : `Student ${user.uid}`;
                    playerContainer.appendChild(nameTag);

                    document.getElementById('remoteVideos').appendChild(playerContainer);
                }

                remoteVideoTrack.play(playerContainer);
                remoteUsers[user.uid] = user;
            }

            if (mediaType === 'audio') {
                const remoteAudioTrack = user.audioTrack;
                remoteAudioTrack.play();
            }
        }

        // Handle remote user unpublished
        function handleUserUnpublished(user, mediaType) {
            console.log('ðŸ‘¤ User unpublished:', user.uid, mediaType);

            if (mediaType === 'video') {
                const playerContainer = document.getElementById(`player-${user.uid}`);
                if (playerContainer) {
                    playerContainer.remove();
                }
            }
        }

        // Handle user left
        function handleUserLeft(user) {
            console.log('ðŸ‘¤ User left:', user.uid);

            const playerContainer = document.getElementById(`player-${user.uid}`);
            if (playerContainer) {
                playerContainer.remove();
            }

            delete remoteUsers[user.uid];
        }

        // Toggle mute
        async function toggleMute() {
            if (!localAudioTrack) return;

            isMuted = !isMuted;
            await localAudioTrack.setEnabled(!isMuted);

            const muteBtn = document.getElementById('muteBtn');
            const muteText = document.getElementById('muteText');

            if (isMuted) {
                muteBtn.classList.add('active');
                muteText.textContent = 'Unmute';
            } else {
                muteBtn.classList.remove('active');
                muteText.textContent = 'Mute';
            }
        }

        // Toggle video
        async function toggleVideo() {
            if (!localVideoTrack) return;

            isVideoOff = !isVideoOff;
            await localVideoTrack.setEnabled(!isVideoOff);

            const videoBtn = document.getElementById('videoBtn');
            const videoText = document.getElementById('videoText');
            const localAvatar = document.getElementById('localAvatar');

            if (isVideoOff) {
                videoBtn.classList.add('active');
                videoText.textContent = 'Start Video';
                // Show avatar when video is off
                if (localAvatar) {
                    localAvatar.classList.remove('hidden');
                }
            } else {
                videoBtn.classList.remove('active');
                videoText.textContent = 'Stop Video';
                // Hide avatar when video is on
                if (localAvatar) {
                    localAvatar.classList.add('hidden');
                }
            }
        }

        // Leave meeting
        async function leaveMeeting() {
            try {
                // Close local tracks
                if (localAudioTrack) {
                    localAudioTrack.close();
                }
                if (localVideoTrack) {
                    localVideoTrack.close();
                }

                // Leave channel
                if (agoraClient) {
                    await agoraClient.leave();
                }

                console.log('âœ… Left meeting');
                window.location.href = 'student-community.html';
            } catch (error) {
                console.error('Error leaving meeting:', error);
                window.location.href = 'student-community.html';
            }
        }

        // Initialize on page load
        window.addEventListener('load', init);

        // Clean up on page unload
        window.addEventListener('beforeunload', async () => {
            if (localAudioTrack) localAudioTrack.close();
            if (localVideoTrack) localVideoTrack.close();
            if (agoraClient) await agoraClient.leave();
        });
    </script>
</body>

</html>