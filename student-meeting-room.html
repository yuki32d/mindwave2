<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meeting Room - MindWave</title>
  <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden}
    body{font-family:'Inter',system-ui,sans-serif;background:#0a0a0f;color:#f0f2ff}

    /* ====== WAITING ROOM ====== */
    #waitingRoom{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1.5rem;background:#0a0a0f;z-index:100}
    #waitingRoom::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 50% at 50% 40%,rgba(99,102,241,.12),transparent 70%);pointer-events:none}
    .wr-logo{display:flex;align-items:center;gap:.75rem;font-size:1.3rem;font-weight:800}
    .wr-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff}
    .wr-card{background:#1a1d2e;border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:2rem;width:calc(100% - 2rem);max-width:400px;display:flex;flex-direction:column;align-items:center;gap:1.25rem;text-align:center}
    .wr-pulse{width:72px;height:72px;border-radius:50%;background:rgba(99,102,241,.15);display:flex;align-items:center;justify-content:center;color:#6366f1;position:relative}
    .wr-pulse::after{content:'';position:absolute;inset:-6px;border-radius:50%;border:2px solid rgba(99,102,241,.3);animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.12);opacity:.5}}
    .wr-pulse svg{width:32px;height:32px}
    .wr-title{font-size:1.1rem;font-weight:700}
    .wr-sub{font-size:.85rem;color:#9ea4b6;line-height:1.6}
    .wr-preview{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden;position:relative}
    .wr-preview video{width:100%;height:100%;object-fit:cover}
    .wr-cam-off{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:.5rem;background:rgba(255,255,255,.03);color:#9ea4b6;font-size:.78rem}
    .wr-cam-off svg{width:24px;height:24px;opacity:.4}
    .wr-name{font-size:.9rem;color:#9ea4b6}
    .wr-leave{padding:.6rem 1.4rem;border-radius:10px;border:1px solid rgba(255,92,92,.3);background:rgba(255,92,92,.1);color:#ff5c5c;font-size:.85rem;font-weight:600;cursor:pointer;transition:background .2s}
    .wr-leave:hover{background:rgba(255,92,92,.2)}

    /* ====== MEETING ROOM ====== */
    #meetingRoom{position:fixed;inset:0;display:none;flex-direction:column;background:#0a0a0f}

    /* Top bar */
    .top-bar{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1.25rem;background:rgba(255,255,255,.03);border-bottom:1px solid rgba(255,255,255,.07);flex-shrink:0}
    .top-brand{display:flex;align-items:center;gap:.6rem;font-weight:700;font-size:1rem}
    .top-brand-icon{width:30px;height:30px;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff}
    .top-brand-icon svg{width:15px;height:15px}
    .meeting-title{font-size:.85rem;color:#9ea4b6;font-weight:400}
    .top-right{display:flex;align-items:center;gap:.75rem}
    .top-tag{display:flex;align-items:center;gap:.4rem;font-size:.75rem;padding:.3rem .75rem;border-radius:20px;background:rgba(34,197,94,.12);color:#22c55e;border:1px solid rgba(34,197,94,.25)}
    .top-tag svg{width:12px;height:12px}

    /* Video grid */
    .video-area{flex:1;overflow:hidden;padding:.75rem;display:flex;flex-direction:column;gap:.75rem}
    #videoGrid{flex:1;display:grid;gap:.75rem;overflow:hidden}
    
    /* Layout helpers */
    .video-area.layout-1 #videoGrid{grid-template-columns:1fr}
    .video-area.layout-2 #videoGrid{grid-template-columns:1fr 1fr}
    .video-area.layout-3,.video-area.layout-4{grid-template-columns:repeat(2,1fr)}
    .video-area.layout-5,.video-area.layout-6{grid-template-columns:repeat(3,1fr)}

    /* Tile */
    .vtile{background:#141625;border-radius:14px;overflow:hidden;position:relative;display:flex;align-items:center;justify-content:center;border:2px solid transparent;transition:border-color .2s}
    .vtile.speaking{border-color:#22c55e}
    .vtile video{width:100%;height:100%;object-fit:cover;display:block}
    .vtile-avatar{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:700;color:#fff}
    .vtile-label{position:absolute;bottom:.6rem;left:.7rem;display:flex;align-items:center;gap:.4rem;font-size:.78rem;font-weight:600;color:#fff;background:rgba(0,0,0,.55);padding:.25rem .6rem;border-radius:6px;backdrop-filter:blur(4px)}
    .vtile-label svg{width:12px;height:12px}
    .vtile-muted{position:absolute;top:.6rem;right:.6rem;width:28px;height:28px;background:rgba(255,92,92,.85);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .vtile-muted svg{width:13px;height:13px;color:#fff}

    /* Chat + participants panel */
    .side-panel{width:320px;background:#111320;border-left:1px solid rgba(255,255,255,.07);display:flex;flex-direction:column;flex-shrink:0}
    .panel-tabs{display:flex;border-bottom:1px solid rgba(255,255,255,.07)}
    .panel-tab{flex:1;padding:.75rem;font-size:.82rem;font-weight:600;background:none;border:none;color:#9ea4b6;cursor:pointer;transition:color .2s,border-color .2s;border-bottom:2px solid transparent;margin-bottom:-1px}
    .panel-tab.active{color:#f0f2ff;border-bottom-color:#6366f1}
    .panel-body{flex:1;overflow:hidden;display:flex;flex-direction:column}
    .tab-view{flex:1;overflow-y:auto;padding:.75rem;display:none}
    .tab-view.active{display:flex;flex-direction:column;gap:.5rem}
    .participant-item{display:flex;align-items:center;gap:.7rem;padding:.5rem;border-radius:10px;background:rgba(255,255,255,.04)}
    .p-av{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:.78rem;font-weight:700;color:#fff;flex-shrink:0}
    .p-name{font-size:.85rem;font-weight:600;flex:1}
    .p-role{font-size:.7rem;color:#9ea4b6;margin-top:.1rem}
    .p-icons{display:flex;gap:.35rem}
    .p-icon{width:24px;height:24px;border-radius:6px;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center}
    .p-icon svg{width:12px;height:12px;color:#9ea4b6}
    .p-icon.muted svg{color:#ff5c5c}
    #chatTab .tab-view{justify-content:flex-end}
    .chat-msg{padding:.5rem .7rem;border-radius:10px;background:rgba(255,255,255,.05);max-width:85%}
    .chat-msg.mine{align-self:flex-end;background:rgba(99,102,241,.2)}
    .chat-sender{font-size:.7rem;font-weight:700;color:#6366f1;margin-bottom:.2rem}
    .chat-text{font-size:.83rem;line-height:1.5}
    .chat-time{font-size:.65rem;color:#9ea4b6;margin-top:.2rem}
    .chat-input-row{display:flex;gap:.5rem;padding:.7rem}
    .chat-inp{flex:1;padding:.6rem .85rem;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#f0f2ff;font-size:.85rem;outline:none}
    .chat-inp:focus{border-color:#6366f1}
    .chat-send{width:38px;height:38px;border-radius:10px;border:none;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .chat-send svg{width:16px;height:16px}

    /* Bottom controls */
    .controls{display:flex;align-items:center;justify-content:center;gap:.75rem;padding:.9rem 1.25rem;background:rgba(0,0,0,.6);backdrop-filter:blur(12px);border-top:1px solid rgba(255,255,255,.07);flex-shrink:0;flex-wrap:wrap}
    .ctrl-btn{display:flex;flex-direction:column;align-items:center;gap:.3rem;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);border-radius:14px;width:56px;height:56px;cursor:pointer;color:#f0f2ff;font-size:.62rem;transition:background .2s,transform .1s;padding:.5rem .25rem;justify-content:center}
    .ctrl-btn:hover{background:rgba(255,255,255,.15);transform:translateY(-1px)}
    .ctrl-btn.muted{background:rgba(255,92,92,.15);border-color:rgba(255,92,92,.3);color:#ff5c5c}
    .ctrl-btn.active{background:rgba(99,102,241,.2);border-color:rgba(99,102,241,.4);color:#a5b4fc}
    .ctrl-btn svg{width:20px;height:20px}
    .ctrl-end{background:rgba(239,68,68,.2);border-color:rgba(239,68,68,.4);color:#f87171;min-width:80px;width:auto;padding:0 1.25rem;flex-direction:row;gap:.5rem;font-size:.82rem;font-weight:600}
    .ctrl-end:hover{background:rgba(239,68,68,.35)}
    .ctrl-end svg{width:18px;height:18px}

    /* Main + panel layout */
    .meeting-body{display:flex;flex:1;overflow:hidden}
    .panel-closed .side-panel{display:none}
  </style>
</head>
<body>

  <!-- Waiting Room -->
  <div id="waitingRoom">
    <div class="wr-logo">
      <div class="wr-logo-icon"><i data-lucide="brain-circuit" style="width:18px;height:18px;"></i></div>
      MindWave
    </div>
    <div class="wr-card">
      <div class="wr-pulse"><i data-lucide="clock" style="width:32px;height:32px;"></i></div>
      <div>
        <div class="wr-title">Waiting for the host to join</div>
        <div class="wr-sub">Once the faculty starts the meeting you will be connected automatically.</div>
      </div>
      <div class="wr-preview">
        <video id="wrVid" autoplay muted playsinline></video>
        <div class="wr-cam-off" id="wrCamOff"><i data-lucide="video-off"></i><span>Camera off</span></div>
      </div>
      <div class="wr-name" id="wrName">Connecting...</div>
      <button class="wr-leave" id="wrLeave"><i data-lucide="log-out" style="width:14px;height:14px;vertical-align:middle;margin-right:.35rem;"></i>Leave</button>
    </div>
  </div>

  <!-- Meeting Room -->
  <div id="meetingRoom">
    <div class="top-bar">
      <div style="display:flex;align-items:center;gap:1rem">
        <div class="top-brand">
          <div class="top-brand-icon"><i data-lucide="brain-circuit"></i></div>
          MindWave
        </div>
        <span class="meeting-title" id="meetingTitle">MindWave Class</span>
      </div>
      <div class="top-right">
        <div class="top-tag"><i data-lucide="circle" style="width:8px;height:8px;"></i> Live</div>
        <span id="timerDisplay" style="font-size:.82rem;color:#9ea4b6;font-variant-numeric:tabular-nums"></span>
      </div>
    </div>

    <div class="meeting-body" id="meetingBody">
      <div class="video-area layout-1" id="videoArea">
        <div id="videoGrid"></div>
      </div>

      <div class="side-panel" id="sidePanel">
        <div class="panel-tabs">
          <button class="panel-tab active" id="tabChat" onclick="switchTab('chat')"><i data-lucide="message-square" style="width:14px;height:14px;vertical-align:middle;margin-right:.35rem;"></i>Chat</button>
          <button class="panel-tab" id="tabParts" onclick="switchTab('participants')"><i data-lucide="users" style="width:14px;height:14px;vertical-align:middle;margin-right:.35rem;"></i>Participants</button>
        </div>
        <div class="panel-body">
          <div class="tab-view active" id="chatView">
          </div>
          <div class="tab-view" id="participantsView">
          </div>
          <div id="chatInputArea">
            <div class="chat-input-row">
              <input class="chat-inp" id="chatInp" placeholder="Send a message..." autocomplete="off">
              <button class="chat-send" id="chatSend" aria-label="Send message"><i data-lucide="send"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="ctrl-btn" id="btnMic" onclick="toggleMic()" title="Toggle microphone" aria-label="Toggle microphone">
        <i data-lucide="mic" id="micIco"></i>
        <span>Mic</span>
      </button>
      <button class="ctrl-btn" id="btnCam" onclick="toggleCam()" title="Toggle camera" aria-label="Toggle camera">
        <i data-lucide="video" id="camIco"></i>
        <span>Camera</span>
      </button>
      <button class="ctrl-btn" id="btnScreen" onclick="toggleScreen()" title="Share screen" aria-label="Share screen">
        <i data-lucide="monitor" id="screenIco"></i>
        <span>Share</span>
      </button>
      <button class="ctrl-btn" id="btnHand" onclick="raiseHand()" title="Raise hand" aria-label="Raise hand">
        <i data-lucide="hand" id="handIco"></i>
        <span>Hand</span>
      </button>
      <button class="ctrl-btn" id="btnPanel" onclick="togglePanel()" title="Toggle panel" aria-label="Toggle panel">
        <i data-lucide="layout-panel-right" id="panelIco"></i>
        <span>Panel</span>
      </button>
      <button class="ctrl-btn ctrl-end" id="btnLeave" onclick="leaveMeeting()" aria-label="Leave meeting">
        <i data-lucide="phone-off"></i>
        Leave
      </button>
    </div>
  </div>

  <script>
    //  URL params 
    const p = new URLSearchParams(location.search);
    const LK_TOKEN  = p.get('lkToken') || '';
    const LK_WS_URL = p.get('wsUrl')   || 'wss://mindwave-rcbmrzha.livekit.cloud';
    const ROOM_NAME = p.get('room')    || '';
    const MY_NAME   = p.get('name')    || 'Student';
    const TITLE     = p.get('title')   || 'MindWave Class';
    const START_CAM = p.get('camOn')   !== '0';
    const START_MIC = p.get('micOn')   !== '0';

    if (!LK_TOKEN) { alert('No meeting token. Returning to lobby.'); window.location.href = 'student-live-meeting.html'; }

    document.getElementById('meetingTitle').textContent = TITLE;
    document.getElementById('wrName').textContent = MY_NAME;

    lucide.createIcons();

    //  State 
    let room = null;
    let localAudio = null, localVideo = null, localScreen = null;
    let micOn = START_MIC, camOn = START_CAM;
    let screenOn = false, handRaised = false, panelOpen = true;
    let metHostJoined = false;
    let startTs = null, timerInterval = null;

    //  Waiting room cam preview 
    let wrStream = null;
    async function startWrPreview() {
      try {
        wrStream = await navigator.mediaDevices.getUserMedia({ video: START_CAM, audio: false });
        document.getElementById('wrVid').srcObject = wrStream;
        document.getElementById('wrCamOff').style.display = START_CAM ? 'none' : 'flex';
        document.getElementById('wrVid').style.display = START_CAM ? 'block' : 'none';
      } catch(e) {
        document.getElementById('wrCamOff').style.display = 'flex';
        document.getElementById('wrVid').style.display = 'none';
      }
    }
    startWrPreview();

    document.getElementById('wrLeave').onclick = () => {
      if(wrStream) wrStream.getTracks().forEach(t=>t.stop());
      window.location.href = 'student-live-meeting.html';
    };

    //  Connect to LiveKit 
    async function connect() {
      if (typeof LivekitClient === 'undefined') {
        console.error('LiveKit client not loaded');
        return;
      }

      room = new LivekitClient.Room({
        adaptiveStream: true,
        dynacast: true,
        videoCaptureDefaults: { resolution: LivekitClient.VideoPresets.h720.resolution }
      });

      room.on(LivekitClient.RoomEvent.ParticipantConnected, onParticipantConnected);
      room.on(LivekitClient.RoomEvent.ParticipantDisconnected, onParticipantDisconnected);
      room.on(LivekitClient.RoomEvent.TrackSubscribed, onTrackSubscribed);
      room.on(LivekitClient.RoomEvent.TrackUnsubscribed, onTrackUnsubscribed);
      room.on(LivekitClient.RoomEvent.ActiveSpeakersChanged, onSpeakersChanged);
      room.on(LivekitClient.RoomEvent.DataReceived, onDataReceived);
      room.on(LivekitClient.RoomEvent.Disconnected, () => { window.location.href = 'student-live-meeting.html'; });

      try {
        await room.connect(LK_WS_URL, LK_TOKEN, { autoSubscribe: true });
      } catch(e) {
        alert('Could not connect to meeting. ' + e.message);
        window.location.href = 'student-live-meeting.html';
        return;
      }

      // Stop waiting room stream
      if(wrStream) { wrStream.getTracks().forEach(t=>t.stop()); wrStream = null; }

      // Publish local tracks
      if(START_MIC) {
        localAudio = await LivekitClient.createLocalAudioTrack({ echoCancellation: true, noiseSuppression: true });
        await room.localParticipant.publishTrack(localAudio);
      }
      if(START_CAM) {
        localVideo = await LivekitClient.createLocalVideoTrack();
        await room.localParticipant.publishTrack(localVideo);
      }

      // Check if any faculty already in room
      checkForHost();
    }

    function checkForHost() {
      let hasHost = false;
      room.remoteParticipants.forEach(rp => {
        const meta = tryParseMeta(rp.metadata);
        if(meta && meta.role === 'faculty') hasHost = true;
      });
      if(hasHost || room.remoteParticipants.size > 0) {
        showMeetingRoom();
      }
    }

    function tryParseMeta(m) {
      try { return JSON.parse(m||''); } catch { return null; }
    }

    function showMeetingRoom() {
      if(metHostJoined) return;
      metHostJoined = true;
      document.getElementById('waitingRoom').style.display = 'none';
      document.getElementById('meetingRoom').style.display = 'flex';
      document.getElementById('meetingRoom').style.flexDirection = 'column';
      renderLocalTile();
      renderAllRemotes();
      startTimer();
    }

    //  Timer 
    function startTimer() {
      startTs = Date.now();
      timerInterval = setInterval(() => {
        const s = Math.floor((Date.now()-startTs)/1000);
        const m = Math.floor(s/60).toString().padStart(2,'0');
        const ss = (s%60).toString().padStart(2,'0');
        document.getElementById('timerDisplay').textContent = m+':'+ss;
      }, 1000);
    }

    //  Participant events 
    function onParticipantConnected(rp) {
      const meta = tryParseMeta(rp.metadata);
      if(meta && meta.role === 'faculty') showMeetingRoom();
      else if(!metHostJoined && room.remoteParticipants.size > 0) showMeetingRoom();
      renderParticipants();
      if(metHostJoined) renderTile(rp);
    }

    function onParticipantDisconnected(rp) {
      const el = document.getElementById('tile-'+rp.identity);
      if(el) el.remove();
      updateGridLayout();
      renderParticipants();
    }

    function onTrackSubscribed(track, pub, rp) {
      const tile = document.getElementById('tile-'+rp.identity);
      if(!tile) renderTile(rp); else attachTrackToTile(tile, track, rp);
    }

    function onTrackUnsubscribed(track, pub, rp) {
      updateTileMedia(rp);
    }

    function onSpeakersChanged(speakers) {
      document.querySelectorAll('.vtile').forEach(t=>t.classList.remove('speaking'));
      speakers.forEach(sp => {
        const t = document.getElementById('tile-'+sp.identity);
        if(t) t.classList.add('speaking');
      });
    }

    function onDataReceived(data, rp) {
      try {
        const msg = JSON.parse(new TextDecoder().decode(data));
        if(msg.type === 'chat') addChatMessage(rp ? rp.name||rp.identity : 'Unknown', msg.text, false);
        if(msg.type === 'hand') addChatMessage('', (rp ? rp.name||rp.identity : 'Someone') + ' raised their hand.', false, true);
      } catch {}
    }

    //  Video tiles 
    function renderLocalTile() {
      const grid = document.getElementById('videoGrid');
      const id = 'tile-local';
      if(document.getElementById(id)) return;
      const tile = makeTile('local', MY_NAME + ' (You)');
      tile.id = id;
      grid.appendChild(tile);
      if(localVideo) {
        const v = tile.querySelector('video');
        if(v) { localVideo.attach(v); v.style.display='block'; tile.querySelector('.vtile-avatar').style.display='none'; }
      }
      updateGridLayout();
    }

    function renderTile(rp) {
      if(!metHostJoined) return;
      const grid = document.getElementById('videoGrid');
      const tileId = 'tile-'+rp.identity;
      if(document.getElementById(tileId)) return;
      const tile = makeTile(rp.identity, rp.name||rp.identity);
      tile.id = tileId;
      grid.appendChild(tile);
      attachTrackToTile(tile, null, rp);
      updateGridLayout();
    }

    function renderAllRemotes() {
      room.remoteParticipants.forEach(rp => renderTile(rp));
    }

    function makeTile(identity, label) {
      const initials = (label||'?').replace(' (You)','').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
      const tile = document.createElement('div');
      tile.className = 'vtile';
      tile.innerHTML = `
        <div class="vtile-avatar">${initials}</div>
        <video autoplay playsinline style="display:none"></video>
        <div class="vtile-label"><span>${label}</span></div>
      `;
      return tile;
    }

    function attachTrackToTile(tile, track, rp) {
      if(!tile) return;
      const vid = tile.querySelector('video');
      const av = tile.querySelector('.vtile-avatar');
      rp.videoTrackPublications.forEach(pub => {
        if(pub.isSubscribed && pub.track && pub.kind === 'video') {
          pub.track.attach(vid); vid.style.display='block'; av.style.display='none';
        }
      });
    }

    function updateTileMedia(rp) {
      const tile = document.getElementById('tile-'+rp.identity);
      if(!tile) return;
      const vid = tile.querySelector('video');
      const av = tile.querySelector('.vtile-avatar');
      let hasVideo = false;
      rp.videoTrackPublications.forEach(pub => { if(pub.isSubscribed && pub.track) hasVideo = true; });
      vid.style.display = hasVideo ? 'block' : 'none';
      av.style.display  = hasVideo ? 'none'  : 'flex';
    }

    function updateGridLayout() {
      const count = document.querySelectorAll('.vtile').length;
      const area = document.getElementById('videoArea');
      area.className = 'video-area layout-'+Math.min(count,6);
    }

    //  Participants panel 
    function renderParticipants() {
      const view = document.getElementById('participantsView');
      view.innerHTML = '';

      const all = [room.localParticipant, ...Array.from(room.remoteParticipants.values())];
      all.forEach(rp => {
        const name = rp.name || rp.identity;
        const initials = name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
        const meta = tryParseMeta(rp.metadata);
        const role = (meta && meta.role) ? meta.role.charAt(0).toUpperCase()+meta.role.slice(1) : 'Student';
        const div = document.createElement('div');
        div.className = 'participant-item';
        div.innerHTML = `<div class="p-av">${initials}</div><div style="flex:1"><div class="p-name">${name}</div><div class="p-role">${role}</div></div>`;
        view.appendChild(div);
      });
    }

    //  Chat 
    function addChatMessage(sender, text, mine, system=false) {
      const view = document.getElementById('chatView');
      const div = document.createElement('div');
      div.className = 'chat-msg' + (mine?' mine':'');
      const time = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      div.innerHTML = (system ? '' : `<div class="chat-sender">${sender}</div>`) + `<div class="chat-text">${text}</div><div class="chat-time">${time}</div>`;
      view.appendChild(div);
      view.scrollTop = view.scrollHeight;
    }

    async function sendChat(text) {
      if(!room||!text.trim()) return;
      const payload = JSON.stringify({ type:'chat', text:text.trim() });
      await room.localParticipant.publishData(new TextEncoder().encode(payload), { reliable:true });
      addChatMessage(MY_NAME+' (You)', text.trim(), true);
    }

    document.getElementById('chatSend').onclick = () => {
      const inp = document.getElementById('chatInp');
      sendChat(inp.value); inp.value='';
    };
    document.getElementById('chatInp').addEventListener('keydown', e => {
      if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); document.getElementById('chatSend').click(); }
    });

    function switchTab(tab) {
      document.getElementById('chatView').classList.toggle('active', tab==='chat');
      document.getElementById('participantsView').classList.toggle('active', tab==='participants');
      document.getElementById('chatInputArea').style.display = tab==='chat'?'block':'none';
      document.getElementById('tabChat').classList.toggle('active', tab==='chat');
      document.getElementById('tabParts').classList.toggle('active', tab==='participants');
      lucide.createIcons();
    }

    //  Controls 
    async function toggleMic() {
      micOn = !micOn;
      if(room) {
        if(micOn && !localAudio) {
          localAudio = await LivekitClient.createLocalAudioTrack({ echoCancellation:true });
          await room.localParticipant.publishTrack(localAudio);
        } else if(localAudio) {
          if(micOn) await localAudio.unmute(); else await localAudio.mute();
        }
      }
      document.getElementById('micIco').setAttribute('data-lucide', micOn?'mic':'mic-off');
      document.getElementById('btnMic').classList.toggle('muted',!micOn);
      lucide.createIcons();
    }

    async function toggleCam() {
      camOn = !camOn;
      if(room) {
        const tile = document.getElementById('tile-local');
        const vid = tile ? tile.querySelector('video') : null;
        const av  = tile ? tile.querySelector('.vtile-avatar') : null;
        if(camOn && !localVideo) {
          localVideo = await LivekitClient.createLocalVideoTrack();
          await room.localParticipant.publishTrack(localVideo);
          if(vid){ localVideo.attach(vid); vid.style.display='block'; if(av)av.style.display='none'; }
        } else if(localVideo) {
          if(camOn){ await localVideo.unmute(); if(vid)vid.style.display='block'; if(av)av.style.display='none'; }
          else { await localVideo.mute(); if(vid)vid.style.display='none'; if(av)av.style.display='flex'; }
        }
      }
      document.getElementById('camIco').setAttribute('data-lucide', camOn?'video':'video-off');
      document.getElementById('btnCam').classList.toggle('muted',!camOn);
      lucide.createIcons();
    }

    async function toggleScreen() {
      if(!screenOn) {
        try {
          localScreen = await LivekitClient.createLocalScreenTracks({ audio:true });
          for(const t of localScreen) await room.localParticipant.publishTrack(t);
          screenOn = true;
          document.getElementById('btnScreen').classList.add('active');
        } catch(e) { screenOn=false; }
      } else {
        if(localScreen) for(const t of localScreen){ await room.localParticipant.unpublishTrack(t); t.stop(); }
        localScreen=null; screenOn=false;
        document.getElementById('btnScreen').classList.remove('active');
      }
      document.getElementById('screenIco').setAttribute('data-lucide', screenOn?'monitor-stop':'monitor');
      lucide.createIcons();
    }

    async function raiseHand() {
      handRaised = !handRaised;
      document.getElementById('btnHand').classList.toggle('active', handRaised);
      if(room) {
        const payload = JSON.stringify({ type:'hand', raised:handRaised });
        await room.localParticipant.publishData(new TextEncoder().encode(payload), { reliable:true });
      }
    }

    function togglePanel() {
      panelOpen = !panelOpen;
      document.getElementById('meetingBody').classList.toggle('panel-closed',!panelOpen);
      document.getElementById('btnPanel').classList.toggle('active',panelOpen);
    }

    function leaveMeeting() {
      if(confirm('Leave the meeting?')) {
        if(room) room.disconnect();
        window.location.href = 'student-live-meeting.html';
      }
    }

    //  Start 
    connect();
  </script>
</body>
</html>